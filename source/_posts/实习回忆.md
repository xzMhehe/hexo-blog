---
title: 2019-2020 实习笔记
date: 2021-07-01 10:43:13
tags:
- 随记
categories:
- 随记
description: 实习回忆
headimg: https://cdn.jsdelivr.net/gh/xzMhehe/StaticFile_CDN/static/img/20210701141043.jpg
thumbnail: https://cdn.jsdelivr.net/gh/xzMhehe/StaticFile_CDN/static/img/20210701141043.jpg
---
时间：2021年7月1日    
     
马上就要实习了，所以整理下之前自己实习的时候学到的东西， 太久不然就忘记了（就是想知道自己之前都写过啥，面试的时候好说）

## 机构管理系统
###  课程模块
**课程分类** 

**控制层**（Controller）         
```java
/**
 * @Author maxinze
 * @Date 2019/8/23
 **/
@RestController
@RequestMapping({"dict/type"})
public class CourseTypeController extends HttpServletController {
    private Logger logger = LoggerFactory.getLogger(SysDictController.class);

    @Autowired
    private CourseTypeService service;

    /**
     * 查询课程树结构的节点
     *
     * @return
     */
    @GetMapping("courses/tree")
    public cn.com.coding4fun.exception.RestResponseEntity<List<TreeNode>> findCoursesTree(@RequestParam(required = false) String signPid) {
        try {
            return new cn.com.coding4fun.exception.RestResponseEntity<List<TreeNode>>().success(service.findCoursesTree(signPid));
        } catch (Exception e) {
            logger.error("get tree failed", e);
            return new RestResponseEntity<List<TreeNode>>().failed(e.getMessage());
        }
    }

    /**
     * 编写面包屑导航字典查询类型
     *
     * @returnen.
     */
    @GetMapping({"breadcrumb"})
    public RestResponseEntity<List<BreadcrumbNode>> findBreadcrumbNodeByType() {
        try {
            List<CascaderNode> cascaderList = service.findCascaderByType();
            List<BreadcrumbNode> breadcrumbNode = BreadcrumbNodeBuilder.findBreadcrumbNode(cascaderList);
            return new RestResponseEntity<List<BreadcrumbNode>>().success(breadcrumbNode);
        } catch (Exception e) {
            logger.error(e.getMessage(), e);
            return new RestResponseEntity<List<BreadcrumbNode>>().failed(e.getMessage());
        }
    }

}
```

**持久层**
```java
/**
 * @Author maxinze
 * @Date 2019/8/23
 **/
@Repository
public class CourseTypeRepository extends AbstractJpaRepository<CourseType, String> {

    public CourseTypeRepository() {
        super(CourseType.class);
    }

    /**
     * 查询所有课程类型
     *
     * @return
     */
    public List<CoursesTreeDTO> findCoursesTypeTree() {
        String queryString = "SELECT \n" +
                "new cn.com.coding4fun.dto.CoursesTreeDTO(\n" +
                "model.pid, \n" +
                "model.parentPid,\n" +
                "model.label,\n" +
                "model.value,\n" +
                "model.descr,\n" +
                "model.remark,\n" +
                "model.sort\n" +
                ") \n" +
                "FROM CourseType model WHERE  model.visible = 0 ORDER BY model.sort";
        return entityManager
                .createQuery(queryString, CoursesTreeDTO.class)
                .getResultList();
    }

    public List<CascaderNode> findCascaderByType() {
        String queryString = "SELECT \n" +
                "new cn.com.coding4fun.iview.CascaderNode(\n" +
                "model.pid, \n" +
                "model.parentPid, \n" +
                "model.label, \n" +
                "model.pid \n" +
                ") \n" +
                "FROM CourseType model WHERE  model.visible = 0 ORDER BY model.sort";
        return entityManager
                .createQuery(queryString, CascaderNode.class)
                .getResultList();
    }

}
```

业务逻辑层(Service)
```java
/**
 * @Author maxinze
 * @Date 2019/8/23
 **/
@Service
public class CourseTypeService implements IBaseJpaService<CourseType, String> {

    @Autowired
    private CourseTypeRepository repository;
    @Autowired
    private SysSignCourseRepository signCourseRepository;

    @Override
    public List<CourseType> findAll() {
        return repository.findAll();
    }

    @Override
    public CourseType findById(String pid) {
        return repository.findById(pid);
    }

    @Override
    public void create(CourseType entity) {
        repository.persist(entity);
    }

    @Override
    public CourseType update(CourseType entity) {
        return repository.merge(entity);
    }

    @Override
    public void delete(String pid) {
        repository.remove(pid);
    }

    @Override
    public void delete(CourseType entity) {
        repository.remove(entity);
    }

    /**
     * 查询课程树结构的节点
     *
     * @param signPid
     * @return
     */
    public List<TreeNode> findCoursesTree(String signPid) {
        List<CoursesTreeDTO> treeNodeList = repository.findCoursesTypeTree();
        List<String> ids = null;
        if (signPid != null && signPid.trim().length() > 0) {
            ids = signCourseRepository.findBySignId(signPid)
                    .stream().map(SysSignCourse::getCourseTypePid).collect(Collectors.toList());
        }
        for (int i = 0; ids != null && ids.size() > 0 && i < treeNodeList.size(); i++) {
            if (ids.contains(treeNodeList.get(i).getId())) {
                treeNodeList.get(i).setChecked(true);
            }
        }
        TreeBuilder<TreeNode> builder = new TreeBuilder(treeNodeList);
        List<TreeNode> tree = builder.buildListToTree();
        return tree;
    }

    /**
     * 获取Iview级联组件格式数据
     *
     * @return
     */
    public List<CascaderNode> findCascaderByType() {
        List<CascaderNode> treeNodeList = repository.findCascaderByType();
        TreeBuilder<CascaderNode> builder = new TreeBuilder(treeNodeList);
        List<CascaderNode> tree = builder.buildListToTree();
        return tree;
    }
}
```

###  员工的模糊查询
查询已经分配给当前员工的批次信息 或当前员工有权限查看的批次信息
```java
    
    /**
     * 控制层 查询已经分配给当前员工的批次信息 或当前员工有权限查看的批次信息
     * @return
     */
    @GetMapping("batchInfo")
    public RestResponseEntity<List<?>> findBatchInfoBySysUserId(@RequestParam String leadName) {
        try {

            return new RestResponseEntity<List<?>>().success(service.findBatchInfoBySysUserId(leadName));
        } catch (Exception e) {
            logger.error("查询分配给当前员工的批次信息失败", e);
            return new RestResponseEntity().failed();
        }
    }

    
    /**
     * 业务逻辑层 查询已经分配给当前员工的批次信息
     * @return
     */
    public List<?> findBatchInfoBySysUserId(String leadName) {
        List<?> list = dao.findBatchInfoBySysUserId(leadName);
        if (list.isEmpty() || list.size() <= 0) {
            return null;
        }
        return list;
    }


    // 持久层
    public List<?> findBatchInfoBySysUserId(String leadName) {
        String authorization = WebContextHolderUtils.getRequest().getHeader(Constants.AUTHORIZATION);
        JWTUtils jwtUtils = new JWTUtils();
        String userId = jwtUtils.getUserId(authorization);
        String permissionString = permissionRepository.findPermissionOfOperator("o", "c", true);
        String queryString = "SELECT\n" +
                "  DISTINCT b.pid AS pid,\n" +
                "  b.batch_number AS batchNumber,\n" +
                "  b.batch_info_source AS batchInfoSource,\n" +
                "  b.create_time AS createTime\n" +
                "FROM\n" +
                "  sys_customer c\n" +
                "  INNER JOIN sys_org o ON c.org_pid = o.pid \n" +
                "  INNER JOIN sys_import_batch b ON c.batch_pid = b.pid \n" +
                "WHERE\n" +
                "  b.batch_info_source LIKE :leadName AND\n" +
                "  (EXISTS ( SELECT a.csr_pid FROM sys_assign a WHERE a.emp_pid = :userId AND a.csr_pid = c.pid AND a.tag_status = 0 ) \n" +
                "  OR " + permissionString + ")\n" +
                "ORDER BY b.create_time DESC";
        return entityManager.unwrap(Session.class)
                .createNativeQuery(queryString)
                .addScalar("pid", StringType.INSTANCE)
                .addScalar("batchNumber",StringType.INSTANCE)
                .addScalar("batchInfoSource",StringType.INSTANCE)
                .addScalar("createTime", LocalDateTimeType.INSTANCE)
                .setResultTransformer(Transformers.ALIAS_TO_ENTITY_MAP)
                .setParameter("userId", userId)
                .setParameter("leadName","%" + leadName + "%")
                .getResultList();

    }
```

查询当前操作用户所在机构的批次编号和批次信息
```java
    /**
     * 控制层 查询当前操作用户所在机构的批次编号和批次信息
     * @return
     */
    @GetMapping("info")
    public RestResponseEntity findBatchNumberAndInfoSource(@RequestParam String leadName) {
        try {
            return new RestResponseEntity().success(service.findBatchNumberAndInfoSource(leadName));
        } catch (Exception e) {
            logger.error(e.getMessage(), e);
            return new RestResponseEntity().failed();
        }
    }

    业务逻辑层
    public List<?> findBatchNumberAndInfoSource(String leadName) {
        return dao.findBatchNumberAndInfoSource(leadName);
    }


   
    /**
     * 持久层 查询当前操作人所在机构下的所有导入数据批次
     * @return
     */
    public List<?> findBatchNumberAndInfoSource(String leadName) {
        HttpServletRequest request = WebContextHolderUtils.getRequest();
        String token = request.getHeader(Constants.AUTHORIZATION);
        JWTUtils jwtUtils = new JWTUtils();
        String orgId = jwtUtils.getOrgId(token);
        SysOrg org = entityManager.find(SysOrg.class, orgId);
        String queryString = "SELECT NEW MAP(b.batchNumber AS batchNumber, b.batchInfoSource AS batchInfoSource) \n" +
                "FROM SysImportBatch b \n" +
                "INNER JOIN SysOrg org ON b.orgPid = org.pid\n" +
                "WHERE org.orgCode LIKE :orgCode AND b.batchInfoSource LIKE :leadName ORDER BY b.createTime DESC";
        return entityManager
                .createQuery(queryString)
                .setParameter("orgCode", org.getOrgCode().substring(0, 3) + "%")
                .setParameter("leadName","%" + leadName + "%")
                .getResultList();
    }
```


### 商品分类模块
```java
@RestController
@RequestMapping("product/type")
public class ProductTypeController {

    private final Logger logger = LoggerFactory.getLogger(this.getClass());

    @Resource
    private ProductTypeService service;

    /**
     * 分类查询树结构的节点
     *
     * @return
     */
    @GetMapping("tree")
    public RestResponseEntity findTree() {
        try {
            return new RestResponseEntity().success(service.findTree());
        } catch (Exception e) {
            logger.error("get tree failed", e);
            return new RestResponseEntity().failed(RestResponseStatus.FAILED);
        }
    }

    /**
     * 创建商品类别、更新商品类别
     * @param treeNode
     * @return
     */
    @PostMapping("saveOrUpdate")
    public RestResponseEntity saveOrUpdate(TreeNodeDTO treeNode) {
        try {
            ProductType dict = new ProductType();
            if (WebStringUtils.isInvalid(treeNode.getId())) {
                Optional<Long> exists = service.findExistTitleByTypes(treeNode.getTitle(), treeNode.getParentId());
                if (exists.isPresent() && exists.get().longValue() > 0) {
                    return new RestResponseEntity().failed(RestResponseStatus.FOUND_RECORD);
                }
                dict.setParentPid(WebStringUtils.isEmpty(treeNode.getParentId()) ? "0" : treeNode.getParentId());
                dict.setTitle(treeNode.getTitle());
                dict.setRemark(treeNode.getRemark());
            } else {
                Optional<Long> exists = service.findExistTitleByTypes(treeNode.getTitle(), treeNode.getParentId());
                ProductType productType = service.findById(treeNode.getId());
                if (productType.getTitle().equals(treeNode.getTitle()) && exists.get().longValue() > 1) {
                    return new RestResponseEntity().failed(RestResponseStatus.FOUND_RECORD);
                } else if (!productType.getTitle().equals(treeNode.getTitle()) && exists.isPresent() && exists.get().longValue() > 0) {
                    return new RestResponseEntity().failed(RestResponseStatus.FOUND_RECORD);
                }
                dict = service.findById(treeNode.getId());
                dict.setParentPid(WebStringUtils.isEmpty(treeNode.getParentId()) ? "0" : treeNode.getParentId());
                dict.setTitle(treeNode.getTitle());
                dict.setRemark(treeNode.getRemark());
                dict.setUpdateTime(LocalDateTime.now());
            }
            service.create(dict);
            if (!dict.getParentPid().equals("0")) {
                // 树形结构计算树形菜单路径
                List<TreeNode> treeNodes = service.findTreeByTitle();
                TreeNode root = new TreeNode();
                root.setId("");
                root.setChildren(treeNodes);
                ArrayList<String> a = new ArrayList<>();
                ArrayList<String> pathList = TreeBuilder.findRootNodeToOtherNodePath(root, dict.getPid(), a);
                StringBuilder result = new StringBuilder("");
                for (int i = 1; i < pathList.size(); i++) {
                    result.append(pathList.get(i)).append(" / ");
                }
                dict.setPath(result.substring(0, result.length() - 3));
                service.create(dict);
            }
            return new RestResponseEntity().success();
        } catch (Exception e) {
            logger.error("create or update tree node failed", e);
            return new RestResponseEntity().failed(RestResponseStatus.FAILED);
        }
    }

    /**
     * 删除商品
     * @param id
     * @return
     */
    @DeleteMapping("{id}")
    public RestResponseEntity delete(@PathVariable String id) {
        try {
            ProductType productType =  service.findById(id);
            if (service.isLeafNode(id)) {
                service.delete(productType);
            }
            return new RestResponseEntity().success();
        } catch (Exception e) {
            logger.error("delete leaf node failed");
            return new RestResponseEntity().failed(RestResponseStatus.FAILED);
        }
    }

    /**
     * 查询商品的级联节点
     * @return
     */
    @GetMapping("cascader")
    public RestResponseEntity findCascaderByType() {
        try {
            return new RestResponseEntity().success(service.findCascaderByType());
        } catch (Exception e) {
            logger.error("cascader select failed", e);
            return new RestResponseEntity().failed(RestResponseStatus.FAILED);
        }
    }

}
```

DTO
```java
package cn.com.coding4fun.dto;

import cn.com.coding4fun.iview.TreeNode;

/**
 * 商品分类
 */
public class TreeNodeDTO extends TreeNode {

    private String id;
    private String parentId;
    private String title;
    private String remark;


    @Override
    public String getId() {
        return id;
    }

    @Override
    public void setId(String id) {
        this.id = id;
    }

    @Override
    public String getParentId() {
        return parentId;
    }

    @Override
    public void setParentId(String parentId) {
        this.parentId = parentId;
    }

    @Override
    public String getTitle() {
        return title;
    }

    @Override
    public void setTitle(String title) {
        this.title = title;
    }

    @Override
    public String getRemark() {
        return remark;
    }

    @Override
    public void setRemark(String remark) {
        this.remark = remark;
    }

    public TreeNodeDTO(String id, String parentId, String title, String remark) {
        this.title = title;
        this.remark = remark;
        this.id = id;
        this.parentId = parentId;
    }

    public TreeNodeDTO() {
    }

    @Override
    public String toString() {
        return "TreeNodeDTO{" +
                "id='" + id + '\'' +
                ", parentId='" + parentId + '\'' +
                ", title='" + title + '\'' +
                ", remark='" + remark + '\'' +
                '}';
    }
}
```

Service
```java
@Service
@Transactional(rollbackFor = Exception.class)
public class ProductTypeService implements IBaseJpaService<ProductType, String>{

    @Resource
    private ProductTypeRepository repository;

    public List<TreeNode> findTreeByTitle() {
        List<TreeNode> treeNodeList = repository.findByTitle();
        TreeBuilder<TreeNode> builder = new TreeBuilder(treeNodeList);
        List<TreeNode> tree = builder.buildListToTree();
        return tree;
    }

    public List<TreeNode> findTree() {
        List<TreeNodeDTO> treeNodeList = repository.findTree();
        TreeBuilder<TreeNode> builder = new TreeBuilder(treeNodeList);
        List<TreeNode> tree = builder.buildListToTree();
        return tree;
    }

    public boolean isLeafNode(String pid) throws Exception {
        if (repository.findByParentId(pid) > 0) {
            throw new Exception("请先删除子节点后，再删除该节点");
        }
        return true;
    }

    @Override
    public List<ProductType> findAll() {
        return repository.findAll();
    }

    @Override
    public ProductType findById(String pid) {
        return repository.findById(pid);
    }

    @Override
    public void create(ProductType productType) {
        repository.persist(productType);
    }

    @Override
    public ProductType update(ProductType productType) {
        return repository.merge(productType);
    }

    @Override
    public void delete(String pid) {
        repository.remove(pid);
    }

    @Override
    public void delete(ProductType productType) {
        repository.remove(productType);
    }

    /**
     * 统计某一分类中存在同一节点下同一名称的个数
     * @param title 分类中的名称
     * @param id 父节点主键
     * @return
     */
    public Optional<Long> findExistTitleByTypes(String title, String id) {
        return repository.findExistTitleByTypes(title, id);
    }

    /**
     * 根据数量总数生成新的value值
     * @return 返回生成的新的value值
     */
    public int getUniqueValue() {
        // 判断当前分类是否存在数据，若不存在则直接返回0
        if (repository.findCountByType().longValue() == 0) {
            return 0;
        }
        // 获取当前分类数据的最大值，并+1后生成新的value值
        return repository.findMaxValue().intValue() + 1;
    }

    public List<CascaderNode> findCascaderByType() {
        List<CascaderNode> treeNodeList = repository.findCascaderByType();
        TreeBuilder<CascaderNode> builder = new TreeBuilder(treeNodeList);
        List<CascaderNode> tree = builder.buildListToTree();
        return tree;
    }

}
```

Repository
```java
@Repository
public class ProductInfoRepository extends AbstractJpaRepository<ProductType, String> {

    public ProductInfoRepository() {
        super(ProductType.class);
    }
}


@Repository
public class ProductTypeRepository extends AbstractJpaRepository<ProductType, String> {

    public ProductTypeRepository() {
        super(ProductType.class);
    }

    public List<TreeNodeDTO> findTree() {
        String queryString = "SELECT new cn.com.coding4fun.dto.TreeNodeDTO(\n" +
                "    model.pid, \n" +
                "    model.parentPid,\n" +
                "    model.title,\n" +
                "    model.remark\n" +
                ") \n" +
                "FROM ProductType model ";
        return entityManager.createQuery(queryString, TreeNodeDTO.class)
                .getResultList();
    }

    public Long findByParentId(String pid) {
        String queryString = "SELECT COUNT(model.pid) FROM ProductType model WHERE model.parentPid = :id";
        return entityManager.createQuery(queryString,Long.class)
                .setParameter("id", pid)
                .getSingleResult();
    }

    public Optional<Long> findExistTitleByTypes(String title, String id) {
        String countString = "SELECT\n" +
                "COUNT(model.pid) \n" +
                "FROM ProductType model\n" +
                "WHERE model.title = :title\n" +
                "AND model.parentPid = :id";
        return entityManager.unwrap(Session.class).createQuery(countString,Long.class)
                .setParameter("title", title)
                .setParameter("id", id)
                .uniqueResultOptional();
    }

    public Long findCountByType() {
        String countString = "SELECT COUNT(model.pid) FROM ProductType model";
        return entityManager.createQuery(countString,Long.class)
                .getSingleResult();

    }

    public Long findMaxValue() {
        String queryString = "SELECT MAX(CAST(model.value AS SIGNED))\n " +
                "FROM ProductType model";
        Object o = entityManager.createQuery(queryString)
                .getSingleResult();
        return  Long.parseLong(o.toString());
    }

    public List<TreeNode> findByTitle() {
        String queryString = "SELECT \n" +
                "new cn.com.coding4fun.dto.TreeNodeDTO(\n" +
                "model.pid, \n" +
                "model.parentPid,\n" +
                "model.title,\n" +
                "model.remark\n" +
                ") \n" +
                "FROM ProductType model";
        return entityManager.createQuery(queryString,TreeNode.class)
                .getResultList();
    }

    public List<CascaderNode> findCascaderByType() {
        String queryString = "SELECT \n" +
                "new cn.com.coding4fun.iview.CascaderNode(\n" +
                "model.pid, \n" +
                "model.parentPid, \n" +
                "model.title, \n" +
                "model.pid \n" +
                ") \n" +
                "FROM ProductType model";
        return entityManager.createQuery(queryString, CascaderNode.class)
                .getResultList();
    }

}
```


### 二维码业务

```java
/**
 * @date 2019/11/13 9:03
 */
@RestController
@RequestMapping("org/qrcode")
@Validated
public class QuickMarkController extends HttpServletController {

    private final static Logger logger = LoggerFactory.getLogger(QuickMarkController.class);

    @Autowired
    private DirectoryConfiguration directoryConfiguration;

    @Autowired
    private QuickMarkService service;

    /**
     * 保存已创建二维码
     *
     * @param title 名称
     * @param status 状态
     * @param remark 备注
     * @param file 文件
     * @return 操作结果信息
     */
    @PostMapping
    public RestResponseEntity save(@RequestParam @NotEmpty String title,
                                   @RequestParam @Range(min = 0, max = 1, message = "状态超出范围") Integer status,
                                   @RequestParam @Size(max = 255, message = "字数已上限") String remark,
                                   @NotNull(message = "请上传二维码") MultipartFile file) {
        try {
            String token = request.getHeader(Constants.AUTHORIZATION);
            JWTUtils jwtUtils = new JWTUtils();
            String userId = jwtUtils.getUserId(token);
            if (service.findByQrTitle(title, service.findParentNodeById()).isPresent()) {
                return new RestResponseEntity().failed(RestResponseStatus.QR_TITLE_EXIST_ERROR);
            }
            if (file != null && !file.getContentType().matches("^image\\/[a-z]*$")) {
                return new RestResponseEntity().failed(RestResponseStatus.QR_TYPE_IllEGAl_ERROR);
            }
            SysOrgQrcodeConfig qrCode = new SysOrgQrcodeConfig();
            String filename = FileUtils.save(directoryConfiguration.getAbsoluteImagePath(), file);
            if (filename == null) {
                return new RestResponseEntity().failed(RestResponseStatus.QR_SAVE_FAILED_ERROR);
            }
            qrCode.setImagePath(directoryConfiguration.getImagePath() + filename);
            qrCode.setTitle(title);
            qrCode.setStatus(status);
            qrCode.setRemark(remark);
            qrCode.setOrgPid(service.findParentNodeById());
            qrCode.setCreateBy(userId);
            service.save(qrCode);
            return new RestResponseEntity().success();
        } catch (Exception e) {
            logger.error("二维码信息创建失败", e);
            return new RestResponseEntity().failed();
        }
    }

    /**
     * 修改二维码详细信息
     *
     * @param id 二维码主键
     * @param title 名称
     * @param status 状态
     * @param remark 备注
     * @return 操作信息
     */
    @PostMapping("update")
    public RestResponseEntity update(@RequestParam @NotEmpty String id,
                                     @RequestParam @NotEmpty String title,
                                     @RequestParam @Range(min = 0, max = 1, message = "状态超出范围") Integer status,
                                     @RequestParam @Size(max = 255, message = "字数已上限") String remark,
                                     @RequestParam(required = false) MultipartFile file) {
        try {
            if (status == null) {
                return new RestResponseEntity().failed(RestResponseStatus.QR_STATUS_NOTEXIST_ERROR);
            }
            String token = request.getHeader(Constants.AUTHORIZATION);
            JWTUtils jwtUtils = new JWTUtils();
            String userId = jwtUtils.getUserId(token);
            SysOrgQrcodeConfig qrCode = service.findById(id);
            if (qrCode == null) {
                return new RestResponseEntity().failed(RestResponseStatus.INVALID_PARAMS);
            }
            if(!qrCode.getTitle().equals(title)) {
                if (service.findByQrTitle(title, service.findParentNodeById()).isPresent()) {
                    return new RestResponseEntity().failed(RestResponseStatus.QR_TITLE_EXIST_ERROR);
                }
            }
            if (file != null && !file.getContentType().matches("^image\\/[a-z]*$")) {
                return new RestResponseEntity().failed(RestResponseStatus.QR_TYPE_IllEGAl_ERROR);
            }
            if (file != null && file.getSize() == 0) {
                return new RestResponseEntity().failed(RestResponseStatus.QR_SIZE_IllEGAl_ERROR);
            }
            if(file != null) {
                String filename = FileUtils.save(directoryConfiguration.getAbsoluteImagePath(), file);
                if (filename == null) {
                    return new RestResponseEntity().failed(RestResponseStatus.QR_SAVE_FAILED_ERROR);
                }
                qrCode.setImagePath(directoryConfiguration.getImagePath() + filename);
            }
            qrCode.setRemark(remark);
            qrCode.setTitle(title);
            qrCode.setUpdateTime(LocalDateTime.now());
            qrCode.setUpdateBy(userId);
            service.updateQr(qrCode, status);
            return new RestResponseEntity().success();
        } catch (Exception e) {
            logger.error("二维码信息修改失败", e);
            return new RestResponseEntity().failed(RestResponseStatus.FAILED);
        }
    }

    /**
     * 获取本机构下所有二维码
     */
    @GetMapping("/all")
    public cn.com.coding4fun.exception.RestResponseEntity findAll() {
        try {
            List<SysOrgQrcodeConfig> list = service.findAllByOrgId(service.findParentNodeById());
            List<QuickMarkDTO> quickMarks =list
                    .stream()
                    .map(e -> new QuickMarkDTO(
                            e.getPid(),
                            e.getTitle(),
                            e.getStatus(),
                            e.getRemark(),
                            e.getImagePath()))
                    .collect(Collectors.toList());
            return new RestResponseEntity().success(quickMarks);
        } catch (Exception e) {
            logger.error("查询当前结点的所有二维码失败", e);
            return new RestResponseEntity().failed(RestResponseStatus.FAILED);
        }
    }

    /**
     * 删除二维码
     *
     * @param id 二维码主键
     * @return 操作信息
     */
    @DeleteMapping
    public RestResponseEntity deleteQrCode(@RequestParam @NotEmpty String id) {
        try {
            SysOrgQrcodeConfig qrCode = this.service.findById(id);
            if (qrCode == null) {
                return new RestResponseEntity().failed(RestResponseStatus.NOT_FOUND_RECORD);
            }
            if (qrCode.getStatus().equals(1)) {
                return new RestResponseEntity().failed(RestResponseStatus.QR_STATUS_ON_ERROR);
            }
            service.delete(qrCode);
            return new RestResponseEntity().success(RestResponseStatus.SUCCESS);
        } catch (Exception e) {
            logger.error("删除失败", e);
            return new RestResponseEntity().failed(RestResponseStatus.NOT_FOUND_RECORD);
        }
    }

}



// 业务逻辑层
/**
 * @date 2019/11/13 9:47
 */
@Transactional
@Service
public class QuickMarkService implements IBaseJpaService<SysOrgQrcodeConfig, String> {

    @Autowired
    private QuickMarkRepository repository;

    @Autowired
    private SysOrgRepository dao;

    /**
     * 验重
     *
     * @param title 二维码名称
     * @param orgPid 机构主键
     * @return 操作信息
     */
    public Optional<SysOrgQrcodeConfig> findByQrTitle(String title, String orgPid) {
        return repository.findByQrTitle(title, orgPid);
    }

    /**
     * 创建二维码
     */
    public void save(SysOrgQrcodeConfig entity) {
        if (entity.getStatus().equals(1)) {
            Optional<SysOrgQrcodeConfig> qrCodeOn = findByOrgPid(findParentNodeById());
            if (qrCodeOn.isPresent()) {
                qrCodeOn.get().setStatus(0);
                qrCodeOn.get().setUpdateTime(LocalDateTime.now());
                qrCodeOn.get().setUpdateBy(entity.getCreateBy());
                repository.merge(qrCodeOn.get());
            }
        }
        repository.persist(entity);
    }

    /**
     * 修改二维码信息
     */
    public void updateQr(SysOrgQrcodeConfig entity, Integer status) {
        if (entity.getStatus().equals(0) && status.equals(1)) {
            Optional<SysOrgQrcodeConfig> qrCodeOn = findByOrgPid(findParentNodeById());
            if (qrCodeOn.isPresent()) {
                qrCodeOn.get().setStatus(0);
                qrCodeOn.get().setUpdateTime(LocalDateTime.now());
                qrCodeOn.get().setUpdateBy(entity.getCreateBy());
                repository.merge(qrCodeOn.get());
            }
        }
        entity.setStatus(status);
        repository.merge(entity);
    }

    /**
     * 获取本机构顶级父节点主键
     */
    public String findParentNodeById() {
        return dao.findParentNodeById();
    }

    /**
     * 查询本机构下所有的二维码
     *
     * @param orgId 机构主键
     */
    public List<SysOrgQrcodeConfig> findAllByOrgId(String orgId) {
        return repository.findAllByOrgId(orgId);
    }

    /**
     * 查找已启用的二维码
     */
    public Optional<SysOrgQrcodeConfig> findByOrgPid(String orgPid) {
        return repository.findByOrgPid(orgPid);
    }

    @Override
    public List<SysOrgQrcodeConfig> findAll() {
        return repository.findAll();
    }

    @Override
    public SysOrgQrcodeConfig findById(String s) {
        return repository.findById(s);
    }

    @Override
    public void create(SysOrgQrcodeConfig entity) {
        repository.persist(entity);
    }

    @Override
    public SysOrgQrcodeConfig update(SysOrgQrcodeConfig entity) {
        return repository.merge(entity);
    }

    @Override
    public void delete(String s) {
        repository.remove(s);
    }

    @Override
    public void delete(SysOrgQrcodeConfig entity) {
        repository.remove(entity);
    }

}


// 持久层
/**
 * @date 2019/11/13 10:25
 */
@Repository
public class QuickMarkRepository extends AbstractJpaRepository<SysOrgQrcodeConfig, String> {

    public QuickMarkRepository() {
        super(SysOrgQrcodeConfig.class);
    }

    /**
     * 根据二维码名称查询本机构的实体
     *
     * @param title 二维码名称
     */
    public Optional< SysOrgQrcodeConfig> findByQrTitle(String title, String orgPid) {
        CriteriaBuilder builder = entityManager.getCriteriaBuilder();
        CriteriaQuery<SysOrgQrcodeConfig> criteria = builder.createQuery(SysOrgQrcodeConfig.class);
        Root<SysOrgQrcodeConfig> root = criteria.from(SysOrgQrcodeConfig.class);
        criteria.select(root);
        criteria.where(builder.equal(root.get("title"), title), builder.equal(root.get("orgPid"), orgPid));
        return entityManager
                .unwrap(Session.class)
                .createQuery(criteria)
                .uniqueResultOptional();
    }

    /**
     * 查找启用本机构的二维码
     *
     */
    public Optional<SysOrgQrcodeConfig> findByOrgPid(String orgPid) {
        String queryString = "SELECT model\n" +
                "FROM SysOrgQrcodeConfig model \n" +
                "WHERE model.orgPid = :orgPid\n" +
                "AND model.status = 1";
        return entityManager
                .unwrap(Session.class)
                .createQuery(queryString, SysOrgQrcodeConfig.class)
                .setParameter("orgPid", orgPid)
                .uniqueResultOptional();
    }

    /**
     * 获取本机构下所有二维码
     *
     * @param orgId 机构主键
     * @return 二维码集合
     */
    public List<SysOrgQrcodeConfig> findAllByOrgId(String orgId) {
        String queryString = "SELECT model\n" +
                "FROM SysOrgQrcodeConfig model \n" +
                "WHERE model.orgPid = :orgId\n" +
                "ORDER BY model.status DESC ";
        return entityManager.createQuery(queryString, SysOrgQrcodeConfig.class)
                .setParameter("orgId", orgId)
                .getResultList();
    }

}


// DTO
/**
 * 二维码信息
 *
 * @author 2460798168@qq.com
 * @date 2019/11/13 10:12
 */
public class QuickMarkDTO {

    /**
     * 修改用的二维码主键
     */
    private String id;

    /**
     * 二维码名称
     */
    private String title;

    /**
     * 启用禁用标记
     */
    private Integer status;

    /**
     * 备注
     */
    private String remark;

    /**
     * 路径
     */
    private String path;
}
```

### 创建、修改课程授权
```java
@RestController
@RequestMapping("/courseAuthorization")
@Validated
public class SysCourseAuthorizationController extends HttpServletController{

    private final Logger logger = LoggerFactory.getLogger(this.getClass());

    @Autowired
    private SysCourseAuthorizationService service;

    @Autowired
    private SysOrgService orgService;

    @Autowired
    private SysOrgCourseService courseService;

    /**
     * 获取单个课程已授权和未授权的老师信息
     *
     * @param cid 课程主键
     * @return    已授权的员工和机构下所有的有效的老师员工的信息
     */
    @GetMapping("/users")
    public RestResponseEntity findUsers(@RequestParam String cid) {
        try {
            SysOrg rootOrg = orgService.findById(orgService.findParentNodeById());
            // 判断操作人所在机构下是否包含所给的课程
            if (!courseService.findCourseOfTheUserOrganization(rootOrg.getPid())
                    .stream().map(SysOrgCourse::getCoursePid).collect(Collectors.toList())
                    .contains(cid)) {
                return new RestResponseEntity().failed(RestResponseStatus.ORG_COURSE_NOT_EXISTS);
            }
            return new RestResponseEntity<>().success(service.findUsersByCoursePid(rootOrg, cid));
        } catch (Exception e) {
            logger.error("获取已授权和未授权的用户失败！", e);
            return new RestResponseEntity().failed();
        }
    }

    /**
     * 创建课程授权
     *
     * @param coursePid 课程主键
     * @param userIds 授权人主键集合
     * @return
     */
    @PostMapping
    public RestResponseEntity saveOrUpdate(@RequestParam @NotEmpty(message = "请选择相应的课程") String coursePid,
                                           @RequestParam(required = false) List<String> userIds) {
        try {
            //找到根机构
            SysOrg rootOrg = orgService.findById(orgService.findParentNodeById());
            if (!courseService.findCourseOfTheUserOrganization(rootOrg.getPid())
                    .stream().map(SysOrgCourse::getCoursePid).collect(Collectors.toList())
                    .contains(coursePid)) {
                return new RestResponseEntity().failed(RestResponseStatus.ORG_COURSE_NOT_EXISTS);
            }
            String userId = new JWTUtils().getUserId(request.getHeader(Constants.AUTHORIZATION));
            service.saveOrUpdate(userId, coursePid, userIds, rootOrg);
            return new RestResponseEntity().success();
        } catch (BusinessRuntimeException e) {
            logger.error("创建更改失败", e);
            return new RestResponseEntity().failed(e.getMessage());
        } catch (Exception e) {
            logger.error("创建更改失败", e);
            return new RestResponseEntity().failed();
        }
    }

    /**
     * 返回当前用户所属机构下所有的课程
     * @param courseTitle 课程名称
     * @param courseType 课程类型
     * @return
     */
    @GetMapping("/orgCourse")
    public RestResponseEntity findAllOrgCourse(@RequestParam(required = false, name = "title") String courseTitle,
                                               @RequestParam(required = false, name = "type") String courseType,
                                               @RequestParam(required = false, name = "tid") String teacherPid) {
        try {
            SysOrg rootOrg = orgService.findById(orgService.findParentNodeById());
            return new RestResponseEntity().success(service.findOrgCourse(rootOrg.getPid(), courseTitle, courseType, teacherPid));
        } catch (Exception e) {
            logger.error("课程管理模块获取机构课程信息错误", e);
            return new RestResponseEntity().failed();
        }
    }

    /**
     * 获取机构下的老师信息，并标记是否拥有课程的授权
     *
     * @param coursePid 课程主键
     * @return List<Map>
     */
    @GetMapping("/users/{coursePid}")
    public RestResponseEntity findAuthorisedTeacherByCoursePid(@PathVariable String coursePid) {
        try {
            SysOrg rootOrg = orgService.findById(orgService.findParentNodeById());
            List<Map> mapList = service.findAuthorisedTeacherByCoursePid(rootOrg.getOrgCode(), coursePid);

            return new RestResponseEntity<>().success(mapList);
        } catch (Exception e) {
            logger.error("获取课程下已授权的老师信息错误", e);
            return new RestResponseEntity().failed();
        }
    }
}


// 业务逻辑层
@Service
public class SysCourseAuthorizationService implements IBaseJpaService<SysAuthorizationUserCourse, String>{

    @Autowired
    private SysCourseAuthorizationRepository dao;

    @Autowired
    private CourseTypeService courseTypeService;

    @Override
    public List<SysAuthorizationUserCourse> findAll() {
        return dao.findAll();
    }

    @Override
    public SysAuthorizationUserCourse findById(String s) {
        return dao.findById(s);
    }

    @Override
    public void create(SysAuthorizationUserCourse sysAuthorizationUserCourse) {
        dao.persist(sysAuthorizationUserCourse);
    }

    @Override
    public SysAuthorizationUserCourse update(SysAuthorizationUserCourse sysAuthorizationUserCourse) {
        return dao.merge(sysAuthorizationUserCourse);
    }

    @Override
    public void delete(String s) {
        dao.remove(s);
    }

    @Override
    public void delete(SysAuthorizationUserCourse sysAuthorizationUserCourse) {
        dao.remove(sysAuthorizationUserCourse);
    }

    /**
     * 获取单个课程已授权和未授权的老师信息
     *
     * @param rootOrg  用户所在的根机构
     * @param coursePid 课程主键
     * @return    已授权的员工和机构下所有的有效的老师员工的信息
     */
    public List<SysUserInfoDTO> findUsersByCoursePid(SysOrg rootOrg, String coursePid) {
        return dao.findAllUser(rootOrg.getOrgCode(), coursePid);
    }

    /**
     * 创建课程授权
     *
     * @param userId 操作人主键
     * @param coursePid 课程主键
     * @param userIds 授权教师主键集合
     * @param sysOrg 操作人机构
     */
    @Transactional(rollbackFor = Exception.class)
    public void saveOrUpdate(String userId, String coursePid, List<String> userIds, SysOrg sysOrg) {
        List<SysAuthorizationUserCourse> sysList = dao.findAllByCoursePid(sysOrg.getPid(), coursePid);
        if(!sysList.isEmpty()) {
            //删除之前授权的
            dao.batchRemove(sysList);
        }
        if (userIds == null || userIds.isEmpty()) {
            return;
        }
        List<SysUser> userInfoList = dao.findSysUserByPidIn(userIds, sysOrg.getOrgCode());
        //验证教师
        if (userInfoList.size() != userIds.size()) {
            throw new BusinessRuntimeException(RestResponseStatus.ORG_TEACHER_NOT_EXISTS);
        }
        //批量存储
        List<SysAuthorizationUserCourse> userCourseList = new ArrayList<>();
        userIds.forEach(e -> {
            //创建课程授权
            SysAuthorizationUserCourse userCourse = new SysAuthorizationUserCourse();
            userCourse.setCreateBy(userId);
            userCourse.setUpdateBy(userId);
            userCourse.setOrgPid(sysOrg.getPid());
            userCourse.setCoursePid(coursePid);
            userCourse.setUserPid(e);
            userCourseList.add(userCourse);
        });
        //批量授权
        dao.batchPersist(userCourseList);
    }

    /**
     * 根据条件返回机构下所有课程
     *
     * @param orgPid      根机构主键
     * @param courseTitle 课程名称
     * @param courseType  课程类别
     * @return
     */
    public List<OrgCourseDTO> findOrgCourse(String orgPid, String courseTitle, String courseType, String teacherPid) {
        List<OrgCourseDTO> restCourse = dao.findOrgCourse(orgPid, courseTitle, courseType, teacherPid);
        List<OrgCourseDTO> sortedCourseList = new ArrayList<>();

        // 根据课程类型的排序值分级进行排序
        List<CascaderNode> cascaderByType = courseTypeService.findCascaderByType(0);
        List<BreadcrumbNode> breadcrumbNode = BreadcrumbNodeBuilder.findBreadcrumbNode(cascaderByType);
        breadcrumbNode.forEach(e -> restCourse.forEach(orgCourseDTO -> {
            if (e.getLastValue().equals(orgCourseDTO.getCourseTypePid())) {
                sortedCourseList.add(orgCourseDTO);
            }
        }));

        List<SysUserInfoDTO> allAuthorizationUser = dao.findAllAuthorizationUser(orgPid);
        Map<String, List<SysUserInfoDTO>> cidMap = allAuthorizationUser.stream().collect(Collectors.groupingBy(SysUserInfoDTO::getAuthorisedCourseId));
        sortedCourseList.forEach((orgCourseDTO -> orgCourseDTO.setUserInfoList(cidMap.get(orgCourseDTO.getCid()))));
        return sortedCourseList;
    }

    /**
     * 获取机构下的老师信息，并标记是否拥有课程的授权
     *
     * @param orgCode 根机构编号
     * @param coursePid 课程主键
     * @return List<SysUser>
     */
    public List<Map> findAuthorisedTeacherByCoursePid(String orgCode, String coursePid) {
        return dao.findAuthorisedTeacherByCoursePid(orgCode, coursePid);
    }
}



// 持久层
@Repository
public class SysCourseAuthorizationRepository extends AbstractJpaRepository<SysAuthorizationUserCourse, String> {

    public SysCourseAuthorizationRepository() { super(SysAuthorizationUserCourse.class); }

    /**
     * 查询机构下给定的课程已授权的教师员工的信息
     *   和 所有的有效的教师员工的信息
     * @param orgCode 根机构编码
     * @return List
     */
    public List<SysUserInfoDTO> findAllUser(String orgCode, String coursePid) {
        String query = "SELECT NEW cn.com.coding4fun.dto.SysUserInfoDTO(\n" +
                "model.pid,\n" +
                "model.userPid,\n" +
                "model.empName,\n" +
                "model.empNo,\n" +
                "(auUser.pid IS NOT NULL))\n" +
                "FROM SysUser model \n" +
                "INNER JOIN UserInfo uInfo ON uInfo.pid = model.userPid\n" +
                "LEFT JOIN SysAuthorizationUserCourse auUser ON auUser.userPid = model.pid AND auUser.coursePid = :coursePid\n" +
                "WHERE \n" +
                "((auUser.pid IS NOT NULL) OR (model.loginStatus = 1 AND uInfo.userStatus = 1)) AND model.delFlag = 0 \n" +
                "AND model.orgPid IN (SELECT org.pid FROM SysOrg org WHERE org.orgCode LIKE :orgCode) ";
        return entityManager.createQuery(query, SysUserInfoDTO.class)
                .setParameter("orgCode", orgCode + "%")
                .setParameter("coursePid", coursePid)
                .getResultList();
    }

    /**
     * 获取机构下所有的已授权的用户信息
     * @param orgPid 机构主键
     * @return SysUserInfoDTO
     */
    public List<SysUserInfoDTO> findAllAuthorizationUser(String orgPid) {
        String query = "SELECT NEW cn.com.coding4fun.dto.SysUserInfoDTO(\n" +
                "model.pid,\n" +
                "model.userPid,\n" +
                "model.empName,\n" +
                "model.empNo,\n" +
                "true,\n" +
                "auCourse.coursePid\n" +
                ")\n" +
                "  FROM SysUser model\n" +
                "  INNER JOIN SysAuthorizationUserCourse auCourse ON auCourse.userPid = model.pid\n" +
                "  WHERE model.delFlag = 0 AND auCourse.orgPid = :orgPid\n" +
                "  ORDER BY model.createTime DESC";
        return entityManager.createQuery(query, SysUserInfoDTO.class)
                .setParameter("orgPid", orgPid)
                .getResultList();
    }

    /**
     * 获取机构下某一课程的全部授权信息
     * @param coursePid 课程信息主键
     * @return
     */
    public List<SysAuthorizationUserCourse> findAllByCoursePid(String orgPid, String coursePid) {
        String queryString = "SELECT model\n" +
                "FROM SysAuthorizationUserCourse model\n" +
                "WHERE model.orgPid = :orgPid AND model.coursePid = :coursePid";

        return entityManager.createQuery(queryString, SysAuthorizationUserCourse.class)
                .setParameter("orgPid", orgPid)
                .setParameter("coursePid", coursePid)
                .getResultList();
    }

    /**
     * 根据条件返回机构下的课程
     * @param orgPid 教育机构主键
     * @param courseTitle 课程名称
     * @param courseTypePid 课程类型
     * @return
     */
    public List<OrgCourseDTO> findOrgCourse(String orgPid, String courseTitle, String courseTypePid, String teacherPid) {
        String queryCourseString = "SELECT NEW cn.com.coding4fun.dto." +
                "OrgCourseDTO(ci.pid," +
                "ci.courseTitle," +
                "ci.courseClassification," +
                "ci.courseVersion, " +
                "ci.courseIcon," +
                "ci.stepTotal) " +
                "FROM SysOrgCourse model " +
                "INNER JOIN CourseInfo ci ON model.coursePid = ci.pid \n " +
                "INNER JOIN CourseType ct ON ci.courseClassification = ct.pid\n";

        StringBuilder builder = new StringBuilder();
        builder.append(" WHERE model.orgPid = '").append(orgPid).append("' AND ci.courseStatus = 1 AND model.delFlag = 0");
        //根据课程名称查询
        if (WebStringUtils.isValid(courseTitle)) {
            String trim = courseTitle.trim();
            builder.append(" AND (ci.courseTitle LIKE ").append("'%").append(trim).append("%'");
            builder.append(" OR ci.courseVersion LIKE ").append("'%").append(trim).append("%')");
        }
        //根据一级课程类型查询
        if (WebStringUtils.isValid(courseTypePid)) {
            builder.append(" AND ( ct.pid = '").append(courseTypePid).append("'")
                    .append(" OR ct.parentPid = '").append(courseTypePid).append("' )");
        }
        //根据老师主键查询
        if (WebStringUtils.isValid(teacherPid)) {
            builder.append("AND ci.pid IN ").append(" (SELECT au.coursePid FROM SysAuthorizationUserCourse au WHERE au.userPid = '").append(teacherPid).append("')");
        }
        builder.append(" ORDER BY ct.sort, ci.createTime DESC");
        return entityManager.createQuery(queryCourseString + builder.toString())
                .getResultList();
    }


    public List<SysUser> findSysUserByPidIn(List<String> pidList, String orgCode) {
        String queryString = "SELECT model \n" +
                "FROM SysUser model \n" +
                "WHERE model.pid IN :pidList\n" +
                "AND model.orgPid IN(SELECT org.pid FROM SysOrg org WHERE org.orgCode LIKE :orgCode)";
        return entityManager.createQuery(queryString, SysUser.class)
                .setParameter("pidList", pidList)
                .setParameter("orgCode", orgCode + "%")
                .getResultList();
    }

    /**
     * 获取机构下的老师信息，并标记是否拥有课程的授权
     *
     * @param orgCode 根机构编号
     * @param coursePid 课程主键
     * @return List<SysUser>
     */
    public List<Map> findAuthorisedTeacherByCoursePid(String orgCode, String coursePid) {
        String queryString = "SELECT NEW MAP(\n" +
                "CONCAT(model.empName, '(', model.empNo, ')') AS empName, \n" +
                "model.pid AS pid, \n" +
                "model.loginName AS loginName,\n" +
                "(auCourse IS NOT NULL) AS authorised)\n" +
                "FROM SysUser model\n" +
                "INNER JOIN UserInfo uInfo ON uInfo.pid = model.userPid AND uInfo.userStatus = 1\n" +
                "LEFT JOIN SysAuthorizationUserCourse auCourse ON auCourse.userPid = model.pid AND auCourse.coursePid = :coursePid\n" +
                "WHERE model.orgPid IN(SELECT org.pid FROM SysOrg org WHERE org.orgCode LIKE :orgCode) AND model.loginStatus = 1";
        return entityManager.createQuery(queryString, Map.class)
                .setParameter("orgCode", orgCode + "%")
                .setParameter("coursePid", coursePid)
                .getResultList();
    }
}
```

### 查询预约时间范围内的客户
```java
/**
     * 根据客户获取跟进预约信息
     * @param id 客户主键
     * @return
     */
    @GetMapping("detail")
    public RestResponseEntity findSysFollowUpReserve(@RequestParam String id){
        try{
            if(WebStringUtils.isInvalid(id)){
                return new RestResponseEntity().failed(RestResponseStatus.LACK_CUSTOMERID);
            }
            return new RestResponseEntity().success(service.findSysFollowUpReserveByCsrId(id));
        }catch (Exception e){
            logger.error("根据客户获取跟进预约信息失败", e);
            return new RestResponseEntity().failed();
        }
    }


    // 业务逻辑层
        /**
     * 通过客户主键查询跟进预约内容
     * @param customerPid 客户主键
     * @return
     */
    public List<SysFollowUpReserveDTO> findSysFollowUpReserveByCsrId(String customerPid) {
        return dao.findFollowUpReserveByCsrId(customerPid);
    }

    // 持久层
    /**
     * 根据客户主键查询跟进预约内容
     * @param customerPid
     * @return
     */
    public List<SysFollowUpReserveDTO> findFollowUpReserveByCsrId(String customerPid) {
        String sqlString = "SELECT\n" +
                "  track.action_way AS actionWay,\n" +
                "  track.create_time AS followUpTime,\n" +
                "  track.action_next_time AS nextFollowUpTime,\n" +
                "  track.descr AS followUpDescr,\n" +
                "  CONCAT(cr.emp_name, IFNULL(CONCAT('(', cr.emp_no, ')'), '')) AS createName,\n" +
                "  res.reserve_type AS reserveType,\n" +
                "  res.reserve_time AS reserveTime,\n" +
                "  res.reserve_descr AS reserveDescr,\n" +
                "  up.emp_name AS updateName\n" +
                "FROM\n" +
                "  sys_follow_up track\n" +
                "  LEFT JOIN sys_reserve res ON track.pid = res.follow_up_pid\n" +
                "  LEFT JOIN sys_user cr ON track.create_by = cr.pid\n" +
                "  LEFT JOIN sys_user up ON track.update_by = up.pid\n" +
                "WHERE\n" +
                "  track.csr_pid = :csrPid\n" +
                "ORDER BY track.create_time DESC";

        return entityManager.unwrap(Session.class).createNativeQuery(sqlString)
                .addScalar("actionWay", IntegerType.INSTANCE)
                .addScalar("followUpTime", LocalDateTimeType.INSTANCE)
                .addScalar("nextFollowUpTime", LocalDateTimeType.INSTANCE)
                .addScalar("followUpDescr", StringType.INSTANCE)
                .addScalar("createName", StringType.INSTANCE)
                .addScalar("reserveType", IntegerType.INSTANCE)
                .addScalar("reserveTime", LocalDateTimeType.INSTANCE)
                .addScalar("reserveDescr", StringType.INSTANCE)
                .addScalar("updateName", StringType.INSTANCE)
                .setParameter("csrPid", customerPid)
                .setResultTransformer(Transformers.aliasToBean(SysFollowUpReserveDTO.class))
                .getResultList();
    }
```



### 试听课报告
```java
    /**
     * 根据用户账号名称模糊查询用户
     *
     * @param userTitle
     * @return
     */
    public List<Map<String, String>> findAuditionUserByUserTitle(String userTitle, String orgCode) {
        //language=MySQL
        String queryString = "SELECT ui.pid AS pid , ui.user_title AS title\n" +
                "FROM user_info ui\n" +
                "LEFT JOIN bind_info bind ON ui.pid = bind.user_pid\n" +
                "WHERE \n" +
                "ui.user_type = 1\n" +
                "AND ui.user_title LIKE :userTitle\n" +
                "OR bind.bind_identifier Like :userTitle";
        return entityManager.createNativeQuery(queryString)
                .unwrap(NativeQueryImpl.class)
                .setResultTransformer(Transformers.ALIAS_TO_ENTITY_MAP)
                .setParameter("userTitle", "%" + userTitle.trim() + "%")
                .getResultList();
    }
```
![](https://cdn.jsdelivr.net/gh/xzMhehe/StaticFile_CDN/static/img/20210701144516.png)
![](https://cdn.jsdelivr.net/gh/xzMhehe/StaticFile_CDN/static/img/20210701145320.png)



## 重构老系统（资源管理系统微服务项目）
                
### 课程章节业务
```java
// 控制层
@RestController
@Validated
public class ChapterController {

    @Autowired
    private ChapterService service;

    /**
     * 创建或修改课程章节
     * @param dto
     * @return
     */
    @ResponseBody
    @PostMapping({"/course/chapter"})
    public ResponseEntity save(ChapterDTO dto) {
        CourseStep chapter = new CourseStep();
        chapter.setPid(dto.getPid());
        chapter.setCoursePid(dto.getCoursePid());
        chapter.setStepDescription(dto.getStepDescription());
        chapter.setStepPoints(dto.getStepPoints());
        chapter.setStepSeq(dto.getStepSeq());
        chapter.setPrevious(dto.getPrevious());
        chapter.setScratchVersion(dto.getScratchVersion());
        chapter.setStepTitle(dto.getStepTitle());
        materialOfScratchConvert(chapter,dto);
        service.save(chapter);
        return ResponseEntity.status(HttpStatus.CREATED).body(Translator.toLocale("system.operator.success.message"));
    }

    private void materialOfScratchConvert(CourseStep chapter, ChapterDTO dto) {
        String materialVersion;
        if (chapter.getScratchVersion().equals(2)) {
            materialVersion = "scratch2";
            chapter.setmMaterialVersion(materialVersion);
            chapter.setmBackdropLibrary(saveFile(dto.getBackdropLibrary()));
            chapter.setmSpriteLibrary(saveFile(dto.getSpriteLibrary()));
            chapter.setmSoundLibrary(saveFile(dto.getSoundLibrary()));
            chapter.setmCostumeLibrary(saveFile(dto.getCostumeLibrary()));
            chapter.setV3SpriteLibrary(null);
            chapter.setV3CostumeLibrary(null);
            chapter.setV3SoundLibrary(null);
            chapter.setV3BackdropLibrary(null);
        } else {
            materialVersion = "scratch3";
            chapter.setmMaterialVersion(materialVersion);
            chapter.setmBackdropLibrary(saveFile(dto.getV3BackdropLibrary()));
            chapter.setmSpriteLibrary(saveFile(dto.getV3SpriteLibrary()));
            chapter.setmSoundLibrary(saveFile(dto.getV3SoundLibrary()));
            chapter.setmCostumeLibrary(saveFile(dto.getV3CostumeLibrary()));
            chapter.setBackdropLibrary(null);
            chapter.setSoundLibrary(null);
            chapter.setCostumeLibrary(null);
            chapter.setSpriteLibrary(null);
        }
    }

    /**
     * 删除课程章节
     * @param id 课程章节表主键
     * @return
     */
    @DeleteMapping("/course/chapter")
    public ResponseEntity deleteById(@RequestParam String id) {
        service.delete(id);
        return ResponseEntity.status(HttpStatus.OK).body(Translator.toLocale("system.operator.success.message"));
    }

    /**
     * 通过课程信息Id查询课程章节
     * @param cid 课程信息主键
     * @return
     */
    @ResponseBody
    @GetMapping({"/course/chapter"})
    public ResponseEntity findByCoursePidOrderByStepSeqAsc(@RequestParam @NotEmpty String cid) {
        List<CourseStepSimple> courseStepSimpleList = service.findByCoursePidOrderByStepSeqAsc(cid);
        return ResponseEntity.ok().body(courseStepSimpleList);
    }

    /**
     * 保存Scratch课程章节素材
     * @param data
     * @return
     */
    private String saveFile(String data) {
        if (data == null || data.isEmpty()) {
            return null;
        }
        DirectoryConfiguration configuration =
                SpringContextUtils.applicationContext.getBean(DirectoryConfiguration.class);
        StringJoiner basePath = new StringJoiner(File.separator);
        basePath.add(configuration.getBasePath());
        basePath.add("course_step").add("material");
        File file = new File(basePath.toString());
        if (!file.exists()) file.mkdirs();
        String filename = Etag.data(data.getBytes(Charset.forName("UTF-8"))) + ".json";
        try {
            FileUtils.writeStringToFile(new File(basePath.add(filename).toString()), data, Charset.forName("UTF-8"));
            return new StringBuilder().append("/course_step/material/").append(filename).toString();
        } catch (IOException e) {
            return null;
        }
    }

}



// 业务逻辑层
/**
 * @Date: 2019/10/18 10:31
 */
@Service
public class ChapterService {

    @Autowired
    private CourseChapterRepository repository;

    @Autowired
    private CourseStepSimpleRepository courseStepSimpleRepository;

    /**
     * 创建或修改课程章节
     *
     * @param chapter 课程章节
     * @throws IOException
     */
    @Transactional(rollbackFor = Exception.class)
    public void save(CourseStep chapter) {
        if (!StringUtils.isEmpty(chapter.getPid())) {
            CourseStep update = repository.findById(chapter.getPid())
                    .orElseThrow(() -> new BusinessException(Translator.toLocale("course.chapter.Record.NotExist.message")));;
            update.setUpdateTime(LocalDateTime.now());
            update.setStepDescription(chapter.getStepDescription());
            update.setStepPoints(chapter.getStepPoints());
            update.setStepSeq(chapter.getStepSeq());
            update.setPrevious(chapter.getPrevious());
            update.setScratchVersion(chapter.getScratchVersion());
            update.setStepTitle(chapter.getStepTitle());
            repository.save(update);
        } else {
            chapter.setCreateTime(LocalDateTime.now());
            repository.save(chapter);
        }
    }

    /**
     * 通过课程Id删除课程步骤
     *
     * @param id 课程章节主键
     */
    @Transactional(rollbackFor = Exception.class)
    public void delete(String id) {
        CourseStep courseStep = repository.findById(id)
                .orElseThrow(() -> new BusinessException(Translator.toLocale("course.chapter.Record.NotExist.message")));
        repository.delete(courseStep);
    }

    /**
     * 通过课程Id查询课程步骤
     *
     * @param courseId 课程信息主键
     * @return
     */
    @Transactional(rollbackFor = Exception.class)
    public List<CourseStepSimple> findByCoursePidOrderByStepSeqAsc(String courseId) {
        return courseStepSimpleRepository.findByCoursePidOrderByStepSeqAsc(courseId);
    }

    /**
     * 检验cid是否在课程章节存在
     *
     * @param id
     * @return
     */
    public Optional<CourseStepSimple> findById(String id) {
        return courseStepSimpleRepository.findById(id);
    }
}


// 持久层
public interface CourseChapterRepository extends JpaRepository<CourseStep, String> {

    <T> List<T> findByCoursePidIn(List<String> ids, Class<T> clazz);

    interface ChapterDetail {
        String getPid();
        String getStepTitle();
        String getCoursePid();
        Integer getStepSeq();
    }
}


public interface CourseStepSimpleRepository extends JpaRepository<CourseStepSimple, String> {

    /**
     * 通过课程Id查询课程步骤
     *
     * @param courseId 课程信息主键
     * @return
     */
    List<CourseStepSimple> findByCoursePidOrderByStepSeqAsc(String courseId);

}

// DTO
/**
 * 课程章节信息
 *
 * @Date: 2019/10/18 10:38
 */
 @Date
public class ChapterDTO {

    /**
     * 课程章节主键
     */
    private String pid;
    /**
     * 课程信息主键
     */
    private String coursePid;
    /**
     * 课程章节名称
     */
    private String stepTitle;
    /**
     * 课程章节描述
     */
    private String stepDescription;
    /**
     * 课程章节知识点
     */
    private String stepPoints;
    /**
     * 课程章节步骤
     */
    private Integer stepSeq;
    /**
     * 是否取获取前一节学生创建的课程章节作品，默认值为1获取，0表示创建默认作品
     */
    private Integer previous;
    /**
     * Scratch素材版本号,scratch2,scratch3
     */
    private String mMaterialVersion;
    /**
     * scratch2.0背景库json
     */
    private String backdropLibrary;
    /**
     * scratch2.0角色库json
     */
    private String costumeLibrary;
    /**
     * scratch2.0声音库json
     */
    private String soundLibrary;
    /**
     * scratch2.0精灵库json
     */
    private String spriteLibrary;
    /**
     * scratch版本
     */
    private Integer scratchVersion;
    /**
     * scratch3.0背景库json
     */
    private String v3BackdropLibrary;
    /**
     * scratch3.0角色库json
     */
    private String v3CostumeLibrary;
    /**
     * scratch3.0声音库json
     */
    private String v3SoundLibrary;
    /**
     * scratch3.0精灵库json
     */
    private String v3SpriteLibrary;
}
```


### 练习题模块
修改课程章节下练习题顺序
```java
// 控制层
/**
     * 修改课程章节下练习题顺序
     *
     * @param cid 课程章节主键
     * @param list 修改题集合
     * @return
     */
    @PutMapping("/course/chapter/question/sort")
    public ResponseEntity updateQuestionSort(@RequestParam @PrimaryKey(message = "{course.chapter.NotExists.message}") String cid,
                                             @RequestBody @NotEmpty(message = "{exercises.id.NotEmpty.message}") List<@Valid ChapterQuestionSortDTO> list) {
        // 检验cid是否在课程章节存在
        Optional<CourseStepSimple> chapterOptional = chapterService.findById(cid);
        chapterOptional.orElseThrow(() -> new BusinessException("course.chapter.NotExists.message"));
        service.updateQuestionSort(cid, list);
        return ResponseEntity.status(HttpStatus.ACCEPTED).body(Translator.toLocale("system.operator.success.message"));
    }


    // 业务逻辑层
    /**
     * 修改课程章节下练习题顺序
     *
     * @param chapterId 课程章节主键
     * @param list 修改的练习题集合
     */
    @Transactional(rollbackFor = Exception.class)
    public void updateQuestionSort(String chapterId, List<ChapterQuestionSortDTO> list) {
        List<String> questionPidList = list.stream().map(ChapterQuestionSortDTO::getId).collect(Collectors.toList());
        //获取课程章节相关的习题
        List<CourseStepQuestion> exercisesOfChapterList =
                courseChapterQuestionRepository.findAllByChapterPidAndQuestionPidIn(chapterId, questionPidList);
        if (list.size() != exercisesOfChapterList.size()) {
            throw new BusinessException("course.chapter.exercises.NotMatching.message");
        }
        Map<String, Integer> collect = list
                .stream()
                .filter(e -> e.getSort() != null)
                .collect(Collectors.toMap(ChapterQuestionSortDTO::getId, ChapterQuestionSortDTO::getSort));
        exercisesOfChapterList.forEach(e -> e.setQuestionSort(collect.get(e.getQuestionPid())));
        courseChapterQuestionRepository.saveAll(exercisesOfChapterList);
    }
```



### 赛事管理
赛事管理
```java
/**
 * 赛事管理
 * @date 2020/3/18 11:47
 */
@RestController
@Validated
public class CompetitionController {

    @Autowired
    private CompetitionService service;

    /**
     * 分页查询所有赛事信息，起始页使用pageNo表示，首页为1；每页数据量使用pageSize
     * @param pageable 分页参数接受对象，详情参考{@link Pageable}
     * @return 返回赛事信息
     */
    @GetMapping({"/competition"})
    public ResponseEntity findAllByPage(@PageableDefault Pageable pageable) {
        return ResponseEntity.ok(service.findAllByPage(pageable));
    }

    /**
     * 查询所有可候选赛事管理员
     * @param name
     * @return
     */
    @GetMapping({"/competition/candidate/admin"})
    public ResponseEntity findAllCandidateAdministrator(@RequestParam(name = "n", required = false) String name) {
        return ResponseEntity.ok(service.findAllCandidateAdministrator(name));
    }

    /**
     * 根据主键查询赛事管理员
     *
     * @return
     */
    @GetMapping({"/competition/admin"})
    public ResponseEntity findAllCompetitionAdministrator(@RequestParam(name = "id") @NotNull Long id) {
        return ResponseEntity.ok(service.findAllCompetitionEmployeeByIdAndRole(id, CompetitionRole.ROLE_ADMIN));
    }

    /**
     * 创建或修改赛事
     * @param dto
     * @return
     * @throws IOException 图片保存有问题时，会报该异常
     */
    @RequestMapping(method = {RequestMethod.POST, RequestMethod.PUT}, value = "/competition")
    public ResponseEntity save(CompetitionDTO dto) throws IOException {
        if (dto.getDeclarationTime().isAfter(dto.getReviewTime()) || dto.getDeclarationTime().isAfter(dto.getAuditTime()) || dto.getDeclarationTime().isAfter(dto.getEndTime())) {
            return new ResponseEntity<>("申报时间不能晚于其余三个时间", HttpStatus.BAD_REQUEST);
        }
        if (dto.getReviewTime().isAfter(dto.getAuditTime()) || dto.getReviewTime().isAfter(dto.getEndTime())) {
            return new ResponseEntity<>("评审时间不能晚于其余两个时间!", HttpStatus.BAD_REQUEST);
        }
        if (dto.getAuditTime().isAfter(dto.getEndTime())) {
            return new ResponseEntity<>("终审时间不能晚于结束时间!", HttpStatus.BAD_REQUEST);
        }
        if (dto.getSponsor().isEmpty()) {
            return new ResponseEntity<>("主办单位不能为空!", HttpStatus.BAD_REQUEST);
        }
        if (dto.getManageTeacher().isEmpty()) {
            return new ResponseEntity<>("请添加赛事管理员!", HttpStatus.BAD_REQUEST);
        }
        CompetitionInfo competitionInfo = new CompetitionInfo();
        competitionInfo.setPid(dto.getPid());
        competitionInfo.setTitle(dto.getTitle());
        competitionInfo.setSponsor(dto.getSponsor());
        competitionInfo.setAwardNumber(dto.getAwardNumber());
        competitionInfo.setContent("");
        competitionInfo.setQuality(dto.getQuality());
        competitionInfo.setDeclarationTime(dto.getDeclarationTime());
        competitionInfo.setReviewTime(dto.getReviewTime());
        competitionInfo.setAuditTime(dto.getAuditTime());
        competitionInfo.setEndTime(dto.getEndTime());
        competitionInfo.setCoOrganizer(StringUtils.hasText(dto.getCoOrganizer()) ? dto.getCoOrganizer() : "");
        competitionInfo.setOrganizer(StringUtils.hasText(dto.getOrganizer()) ? dto.getOrganizer() : "");
        service.save(competitionInfo, dto.getThumbnailPic(), dto.getCoverPic(), dto.getManageTeacher());
        if(dto.getPid() != null) {
            return ResponseEntity.status(HttpStatus.ACCEPTED).body(Translator.toLocale("system.operator.success.message"));
        }
        return ResponseEntity.status(HttpStatus.ALREADY_REPORTED).body(competitionInfo.getPid());
    }

    /**
     * 保存赛事内容
     *
     * @param competitionPid
     * @param content
     * @return
     */
    @PutMapping("/competition/content")
    public ResponseEntity saveContent(@RequestParam(name = "pid") @NotNull Long competitionPid,
                                      @RequestParam(name = "content") @NotEmpty(message = "{competition.content.NotExists.message}") String content) {
        CompetitionInfo competitionInfo = service.findByPidAndDelFlag(competitionPid).orElseThrow(() -> new BusinessException(
                HttpStatus.BAD_REQUEST, Translator.toLocale("competition.pid.NotFound.message")));
        competitionInfo.setContent(content);
        service.save(competitionInfo);
        return ResponseEntity.status(HttpStatus.ACCEPTED).body(Translator.toLocale("system.operator.success.message"));
    }

    /**
     * 发布比赛
     *
     * @param competitionPid 赛事主键
     * @return
     */
    @PutMapping("/competition/release")
    public ResponseEntity releaseCompetition(@RequestParam(name = "pid") @NotNull Long competitionPid) {
        CompetitionInfo competitionInfo = service.findByPidAndDelFlag(competitionPid).orElseThrow(() -> new BusinessException(
                HttpStatus.BAD_REQUEST, Translator.toLocale("competition.pid.NotFound.message")));
        //检查赛事是否未发布
        if (competitionInfo.getStatus().compareTo(CompetitionStatusEnum.UNPUBLISHED.getValue()) != 0) {
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(Translator.toLocale("competition.status.ErrorStatus.message"));
        }
        competitionInfo.setStatus(CompetitionStatusEnum.PUBLISHED.getValue());
        service.save(competitionInfo);
        return ResponseEntity.status(HttpStatus.ACCEPTED).body(Translator.toLocale("system.operator.success.message"));
    }

    /**
     * 终止比赛
     *
     * @param competitionPid 赛事主键
     * @return
     */
    @PutMapping("/competition/end")
    public ResponseEntity endCompetition(@RequestParam(name = "pid") @NotNull Long competitionPid) {
        CompetitionInfo competitionInfo = service.findByPidAndDelFlag(competitionPid).orElseThrow(() -> new BusinessException(
                HttpStatus.BAD_REQUEST, Translator.toLocale("competition.pid.NotFound")));
        if (competitionInfo.getStatus().compareTo(CompetitionStatusEnum.UNPUBLISHED.getValue()) == 0) {
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(Translator.toLocale("competition.status.NotRelease.message"));
        }
        //检查赛事是否已经结束
        if (competitionInfo.getStatus().compareTo(CompetitionStatusEnum.END.getValue()) == 0) {
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(Translator.toLocale("competition.status.EndStatus.message"));
        }
        competitionInfo.setStatus(CompetitionStatusEnum.END.getValue());
        service.save(competitionInfo);
        return ResponseEntity.status(HttpStatus.ACCEPTED).body(Translator.toLocale("system.operator.success.message"));
    }

    /**
     * 删除赛事
     *
     * @param competitionPid
     * @return
     */
    @DeleteMapping("/competition")
    public ResponseEntity delete(@RequestParam(name = "pid") @NotNull Long competitionPid) {
        CompetitionInfo competitionInfo = service.findByPidAndDelFlag(competitionPid).orElseThrow(() -> new BusinessException(
                HttpStatus.BAD_REQUEST, Translator.toLocale("competition.pid.NotFound.message")));
        competitionInfo.setDelFlag(EntityDeleteEnum.DELETED.getValue());
        service.save(competitionInfo);
        return ResponseEntity.status(HttpStatus.ACCEPTED).body(Translator.toLocale("system.operator.success.message"));
    }

}



// 业务逻辑层
/**
 *
 * @date 2020/3/18 11:49
 */
@Service
public class CompetitionService {

    @Autowired
    private CompetitionInfoRepository repository;

    @Autowired
    private DirectoryConfiguration configuration;

    @Autowired
    private SysUserRepository sysUserRepository;

    @Autowired
    private CompetitionEmployeeRepository employeeRepository;

    /**
     * 分页查询所有赛事信息，起始页使用pageNo表示，首页为1；每页数据量使用pageSize
     * @param pageable 分页参数接受对象，详情参考{@link Pageable}
     * @return 返回赛事信息
     */
    public Page findAllByPage(Pageable pageable) {
        return repository.findAllByDelFlagOrderByCreateAtDesc(pageable, 0);
    }

    /**
     * 根据员工姓名或登录账号或员工绑定学习平台账号所有可分配的赛事管理员
     * @param name 员工姓名/员工登录账号/员工绑定学习平台用户名
     * @return 返回查询到的所有员工详细信息，详情参考{@link EmployeeDetails}对象
     */
    public List<EmployeeDetails> findAllCandidateAdministrator(String name) {
        name = StringUtils.hasText(name) ? "%" + name + "%" : "%%";
        return repository.findAllCandidateAdministrator(name);
    }

    /**
     * 根据赛事编号({@link CompetitionInfo#getPid()})和
     * 赛事工作人员角色({@link CompetitionEmployee#getRolePid()})查询赛事的所有工作人员
     * @param id  赛事编号，详情参考{@link CompetitionInfo#getPid()}
     * @param role  赛事角色，详情参考{@link CompetitionRole}
     * @return 返回赛事工作人员详细信息
     */
    public List<EmployeeDetails> findAllCompetitionEmployeeByIdAndRole(Long id, CompetitionRole role) {
        return repository.findAllCompetitionEmployeeByIdAndRole(id, role.name()).stream().distinct().collect(Collectors.toList());
    }

    /**
     * 创建或修改赛事
     * @param competitionInfo
     * @param imageOne 缩略图
     * @param imageTwo 封面图片
     * @param manageList 赛事管理员集合
     * @throws IOException 图片保存有问题时，会报该异常
     */
    @Transactional(rollbackFor = Exception.class)
    public void save(CompetitionInfo competitionInfo, MultipartFile imageOne, MultipartFile imageTwo, List<String> manageList) throws IOException {
        List<UserInfo> manages = sysUserRepository.findAllByPidIn(manageList);
        if (manages.size() != manageList.size()) {  // 判断客户端提供的赛事管理员和数据库中的数据是否一致
            throw new BusinessException(HttpStatus.BAD_REQUEST, Translator.toLocale("organization.loginUser.NotExists.message"));
        }
        // 根据赛事名称查询该赛事是否已经创建过了
        List<CompetitionInfo> competitionInfoList = repository.findAllByTitleAndDelFlag(competitionInfo.getTitle(), EntityDeleteEnum.NOT_DELETED.getValue());
        List<CompetitionEmployee> employeeList = new ArrayList<>();
        if (competitionInfo.getPid() != null) {
            CompetitionInfo update = repository.findById(competitionInfo.getPid())
                    .orElseThrow(() -> new BusinessException(Translator.toLocale("competition.NotExists.message")));
            if(!update.getTitle().equals(competitionInfo.getTitle()) && !competitionInfoList.isEmpty()) {
                throw new BusinessException(HttpStatus.BAD_REQUEST, Translator.toLocale("competition.competitionTitle.exists"));
            }
            String thumbnail = FileUtils.save(configuration.getAbsoluteCourseThumbnailPath(), imageOne);   // 保存缩略图
            String coverImage = FileUtils.save(configuration.getAbsoluteCourseThumbnailPath(), imageTwo);  // 保存赛事封面图片
            update.setTitle(competitionInfo.getTitle());
            update.setSponsor(competitionInfo.getSponsor());
            update.setCoOrganizer(competitionInfo.getCoOrganizer());
            update.setOrganizer(competitionInfo.getOrganizer());
            update.setQuality(competitionInfo.getQuality());
            update.setDeclarationTime(competitionInfo.getDeclarationTime());
            update.setReviewTime(competitionInfo.getReviewTime());
            update.setAuditTime(competitionInfo.getAuditTime());
            update.setEndTime(competitionInfo.getEndTime());
            update.setThumbnail(StringUtils.hasText(thumbnail) ? configuration.getCourseThumbnailPath() + thumbnail : update.getThumbnail());
            update.setCoverImage(StringUtils.hasText(coverImage) ? configuration.getCourseThumbnailPath() + coverImage : update.getCoverImage());
            repository.save(update);
            deleteAdministratorOfCompetition(update.getPid(), CompetitionRole.ROLE_ADMIN);
            manageList.forEach(e -> {
                CompetitionEmployee employee = new CompetitionEmployee();
                employee.setCompetitionPid(competitionInfo.getPid());
                employee.setUserPid(e);
                employee.setRolePid(Long.valueOf(1));
                employeeList.add(employee);
            });
        } else {
            if(!competitionInfoList.isEmpty()) {
                throw new BusinessException(HttpStatus.BAD_REQUEST, Translator.toLocale("competition.competitionTitle.exists"));
            }
            String thumbnail = FileUtils.save(configuration.getAbsoluteCourseThumbnailPath(), imageOne);   // 保存缩略图
            String coverImage = FileUtils.save(configuration.getAbsoluteCourseThumbnailPath(), imageTwo);  // 保存赛事封面图片
            competitionInfo.setThumbnail(StringUtils.hasText(thumbnail) ? configuration.getCourseThumbnailPath() + thumbnail : "");
            competitionInfo.setCoverImage(StringUtils.hasText(coverImage) ? configuration.getCourseThumbnailPath() + coverImage : "");
            competitionInfo.setStatus(CompetitionStatusEnum.UNPUBLISHED.getValue());
            repository.save(competitionInfo);
            competitionInfo.setInvitationCode(getInvitationCode(competitionInfo.getPid()));
            competitionInfo.setAdviserInvitationCode(getInvitationCode(competitionInfo.getPid()));
            competitionInfo.setJudgeInvitationCode(getInvitationCode(competitionInfo.getPid()));
            manageList.forEach(e -> {
                CompetitionEmployee employee = new CompetitionEmployee();
                employee.setCompetitionPid(competitionInfo.getPid());
                employee.setUserPid(e);
                employee.setRolePid(Long.valueOf(1));
                employeeList.add(employee);
            });
        }
        employeeRepository.saveAll(employeeList);
    }

    /**
     * 保存赛事
     *
     * @param competitionInfo
     */
    @Transactional(rollbackFor = Exception.class)
    public void save(CompetitionInfo competitionInfo) {
        repository.save(competitionInfo);
    }

    /**
     * 返回未被删除的赛事
     *
     * @param competitionPid 赛事主键
     * @return
     */
    public Optional<CompetitionInfo> findByPidAndDelFlag(Long competitionPid) {
        return repository.findByPidAndDelFlag(competitionPid, EntityDeleteEnum.NOT_DELETED.getValue());
    }

    /**
     * 根据赛事主键递归获取邀请码
     * @param id 赛事主键
     * @return 返回邀请码
     */
    public String getInvitationCode(long id) {
        String invitationCode = CompetitionUtils.getInstance().getInvitationCode(id);
        long codeNumber = repository.countByInvitationCodeOrAdviserInvitationCodeOrJudgeInvitationCode(invitationCode, invitationCode, invitationCode);
        if (codeNumber == 0) return invitationCode;
        return getInvitationCode(id);
    }

    /**
     * 根据赛事主键和赛事工作人员身份删除相关赛事人员
     * @param id 赛事信息主键，详情参考{@link CompetitionInfo#getPid()}
     * @param role 赛事员工角色，详情参考{@link CompetitionRole#name()}
     */
    public void deleteAdministratorOfCompetition(long id, CompetitionRole role) {
        List<CompetitionEmployee> employees =
                employeeRepository.findAllByCompetitionPidAndRoleName(id, role.name());
        employeeRepository.deleteAll(employees);
    }
}


// 持久层
public interface CompetitionInfoRepository extends JpaRepository<CompetitionInfo, Long> {

    Optional<CompetitionInfo> findByPidAndDelFlag(Long pid, Integer deleteFlag);

    @Query("SELECT NEW cn.com.coding4fun.admin.web.feature.competition.EmployeeDetails(\n" +
            "  u.pid, \n" +
            "  u.userTitle, \n" +
            "  su.loginName, \n" +
            "  su.empName,\n" +
            "  root.orgTitle)\n" +
            "FROM SysUser su \n" +
            "INNER JOIN UserInfo u ON su.userPid = u.pid\n" +
            "INNER JOIN SysOrg o ON su.orgPid = o.pid\n" +
            "INNER JOIN SysOrg root ON root.orgCode = SUBSTRING(o.orgCode, 1, 3)\n" +
            "WHERE su.delFlag = 0 \n" +
            "AND (su.loginName LIKE :name\n" +
            "OR su.empName LIKE :name\n" +
            "OR u.userTitle LIKE :name\n" +
            "OR root.orgTitle LIKE :name)\n" +
            "ORDER BY su.createTime DESC")
    List<EmployeeDetails> findAllCandidateAdministrator(@Param("name") String name);

    @Query("SELECT NEW cn.com.coding4fun.admin.web.feature.competition.EmployeeDetails(\n" +
            "  u.pid, \n" +
            "  u.userTitle, \n" +
            "  su.loginName, \n" +
            "  su.empName,\n" +
            "  root.orgTitle)\n" +
            "FROM CompetitionEmployee cm\n" +
            "INNER JOIN CompetitionRole role ON cm.rolePid = role.pid\n" +
            "INNER JOIN UserInfo u ON cm.userPid = u.pid\n" +
            "INNER JOIN SysUser su ON su.userPid = u.pid\n" +
            "INNER JOIN SysOrg o ON su.orgPid = o.pid\n" +
            "INNER JOIN SysOrg root ON root.orgCode = SUBSTRING(o.orgCode, 1, 3)\n" +
            "WHERE cm.competitionPid = :id AND role.role = :role\n" +
            "ORDER BY su.createTime DESC")
    List<EmployeeDetails> findAllCompetitionEmployeeByIdAndRole(Long id, String role);

    Page findAllByDelFlagOrderByCreateAtDesc(Pageable pageable, Integer delFlag);

    List<CompetitionInfo> findAllByTitleAndDelFlag(String title, Integer delFlag);

    List<CompetitionInfo> findAll();

    @Lock(LockModeType.PESSIMISTIC_WRITE)
    long countByInvitationCodeOrAdviserInvitationCodeOrJudgeInvitationCode(String code, String code1, String code2);
}
```
![](https://cdn.jsdelivr.net/gh/xzMhehe/StaticFile_CDN/static/img/20210701151957.png)

![](https://cdn.jsdelivr.net/gh/xzMhehe/StaticFile_CDN/static/img/20210701151754.png)



## 赛事系统（微服务）
### 创建分组
当前登录人创建分组、查看当前登录人创建的分组、给分组添加已有用户
```java
/**
 * 分组详情控制器
 *
 * @Date 2019/10/23 13:29
 */
@RestController
@Validated
public class GroupDetailsController extends AbstractAuthorizationDetails {

    @Autowired
    private GroupDetailsService service;

    /**
     * 分页显示教师创建的分组
     *
     * @param page
     * @param title     分组名称,默认值为""
     * @param startTime 起始时间
     * @param endTime   结束时间
     * @return
     */
    @GetMapping({"/group/details"})
    public ResponseEntity findAllByPage(@PageableDefault Pageable page,
                                        @RequestParam(required = false) String title,
                                        @RequestParam(required = false) @DateTimeFormat(pattern = "yyyy-MM-dd") LocalDate startTime,
                                        @RequestParam(required = false) @DateTimeFormat(pattern = "yyyy-MM-dd") LocalDate endTime) {
        if (startTime != null && endTime != null && startTime.isAfter(endTime)) {
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(Translator.toLocale("group.time.Failed.message"));
        }
        if (startTime == null && endTime != null || startTime != null && endTime == null) {
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(Translator.toLocale("group.time.NotEmpty.message"));
        }
        LocalDateTime startLocalDateTime = null;
        LocalDateTime endLocalDateTime = null;
        if (startTime != null || endTime != null) {
            startLocalDateTime = LocalDateTime.of(startTime, LocalTime.of(0, 0));
            endLocalDateTime = LocalDateTime.of(endTime, LocalTime.of(23, 59));
        }
        Map<String, Long> countUsrs = service.countGroupUserNumberByOperatorId(getOperatorId());
        Page<GroupDetails> data = service.findAllByPage(getOperatorId(), title, startLocalDateTime, endLocalDateTime, page);
        Page<GroupDetailsDTO> dataDto = data.map(groupDetails -> new GroupDetailsDTO(
                groupDetails.getPid(),
                groupDetails.getOrgPid(),
                groupDetails.getUserPid(),
                groupDetails.getGroupName(),
                groupDetails.getCreateTime(),
                groupDetails.getGroupDesc(),
                groupDetails.getInviteCode(),
                countUsrs.get(groupDetails.getPid())
        ));
        return ResponseEntity.ok(dataDto);
    }

    @GetMapping({"/group/details/simple"})
    public ResponseEntity findAllGroupSimpleInfo() {
        return ResponseEntity.ok(service.findAllGroupSimpleInfo(getOperatorId()));
    }

    @GetMapping({"/group/inviteCode"})
    public ResponseEntity generateInviteCode(@RequestParam String id) {
        service.generateInviteCode(id);
        return ResponseEntity.status(HttpStatus.ACCEPTED).body(Translator.toLocale("system.operator.success.message"));
    }

    @GetMapping({"/group/inviteCode/batch"})
    public ResponseEntity generateInviteCodeBatch() {
        service.generateInviteCodeBatch();
        return ResponseEntity.status(HttpStatus.ACCEPTED).body(Translator.toLocale("system.operator.success.message"));
    }

    /**
     * 教师创建分组
     *
     * @param title 分组名称
     * @param desc  分组描述
     * @return HttpStatus.CREATED
     */
    @PostMapping("/group/details")
    public ResponseEntity save(
            @RequestParam @NotEmpty(message = "{group.name.NotExists.message}") String title,
            @RequestParam(required = false) String desc) {
        if (service.countByGroupNameAndOrgPid(title, getOrgIdOfOperator()).compareTo(0L) != 0) {
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(Translator.toLocale("group.name.Exists.message"));
        }
        GroupDetails groupDetails = new GroupDetails();
        groupDetails.setOrgPid(getOrgIdOfOperator());
        groupDetails.setUserPid(getOperatorId());
        groupDetails.setGroupName(title);
        groupDetails.setGroupDesc(desc);
        service.save(groupDetails);
        return ResponseEntity.status(HttpStatus.CREATED).body(Translator.toLocale("system.operator.success.message"));
    }

    /**
     * 修改分组信息
     *
     * @param id    分组主键
     * @param title 分组名称
     * @param desc  分组描述
     * @return HttpStatus.ACCEPTED
     */
    @PutMapping("/group/details")
    public ResponseEntity update(
            @RequestParam @PrimaryKey(message = "{group.NotExists.message}") String id,
            @RequestParam @NotEmpty(message = "{group.name.NotExists.message}") String title,
            @RequestParam(required = false) String desc) {
        Optional<GroupDetails> groupDetailsOptional = service.findById(id);
        GroupDetails groupDetails = groupDetailsOptional.orElseThrow(
                () -> new BusinessException(HttpStatus.BAD_REQUEST, Translator.toLocale("group.NotExists.message")));
        if (!groupDetails.getGroupName().equals(title)
                && service.countByGroupNameAndOrgPid(title, getOrgIdOfOperator()).compareTo(0L) != 0) {
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(Translator.toLocale("group.name.Exists.message"));
        }
        groupDetails.setGroupName(title);
        if (WebStringUtils.isValid(desc)) {
            groupDetails.setGroupDesc(desc);
        }
        service.save(groupDetails);
        return ResponseEntity.status(HttpStatus.ACCEPTED).body(Translator.toLocale("system.operator.success.message"));
    }

    /**
     * 删除分组
     *
     * @param id 分组信息主键
     * @return HttpStatus.ACCEPTED
     */
    @DeleteMapping("/group/details")
    public ResponseEntity delete(@RequestParam @PrimaryKey(message = "{group.NotExists.message}") String id) {
        Optional<GroupDetails> groupDetailsOptional = service.findById(id);
        groupDetailsOptional.orElseThrow(
                () -> new BusinessException(HttpStatus.BAD_REQUEST, Translator.toLocale("group.NotExists.message")));
        if (service.countByGroupDetailsPid(id) > 0) {
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(Translator.toLocale("group.user.Exists.message"));
        }
        service.delete(id);
        return ResponseEntity.status(HttpStatus.ACCEPTED).body(Translator.toLocale("system.operator.success.message"));
    }


}


// 业务逻辑层
@Service
public class GroupDetailsService {

    @Autowired
    private GroupDetailsRepository repository;

    @Autowired
    private GroupDetailsUserRepository groupDetailsUserRepository;

    private final int generate_code_max_try = 5;

    /**
     * 分页显示教师创建的分组
     *
     * @param title    分组名称
     * @param uid      用户主键
     * @param pageable 分页
     * @return
     */
    @Transactional(readOnly = true)
    @SuppressWarnings("unchecked")
    public Page<GroupDetails> findAllByPage(String uid, String title, LocalDateTime startTime, LocalDateTime endTime, Pageable pageable) {
        return repository.findAll((root, query, criteriaBuilder) -> {
            List<Predicate> predicateList = new ArrayList<>();
            predicateList.add(criteriaBuilder.equal(root.get("userPid"), uid));
            if (startTime != null || endTime != null) {
                predicateList.add(criteriaBuilder.between(root.get("createTime"), startTime, endTime));
            }
            if (title != null && !title.isEmpty()) {
                predicateList.add(criteriaBuilder.like(root.get("groupName"), "%" + title.trim() + "%"));
            }
            if (predicateList.size() > 0) {
                Predicate[] predicates = new Predicate[predicateList.size()];
                for (int i = 0; i < predicates.length; i++) {
                    predicates[i] = predicateList.get(i);
                }
                query.where(predicates);
            }
            query.orderBy(criteriaBuilder.desc(root.get("createTime")));
            return query.getRestriction();
        }, pageable);
    }

    /**
     * 查询创建人创建每个分组的人数Map集合 String分组主键
     *
     * @param usrPid 创建人pid
     * @return
     */
    @Transactional(readOnly = true)
    public Map<String, Long> countGroupUserNumberByOperatorId(String usrPid) {
        Map<String, Long> map = repository.countGroupUserNumberByOperatorId(usrPid)
                .collect(Collectors.toMap(arr -> (String) arr[0], arr -> (long) arr[1]));
        return map;
    }

    /**
     * 查询该分组人数
     *
     * @param pid
     * @return
     */
    @Transactional(readOnly = true)
    public long countByGroupDetailsPid(String pid) {
        return groupDetailsUserRepository.countByGroupDetailsPid(pid);
    }

    /**
     * 判断分组名称在机构下是否存在
     *
     * @param groupName 分组名称
     * @param orgPid    分组所在的机构主键
     * @return
     */
    @Transactional(readOnly = true)
    public Long countByGroupNameAndOrgPid(String groupName, String orgPid) {
        return repository.countByGroupNameAndOrgPid(groupName, orgPid);
    }

    /**
     * 添加或修改分组信息
     *
     * @param groupDetails 分组信息的实体类
     */
    @Transactional(rollbackFor = Exception.class)
    public void save(GroupDetails groupDetails) {
        if (groupDetails.getPid() == null) {
            groupDetails.setInviteCode(generateInviteCode());
        }
        repository.save(groupDetails);
    }

    /**
     * 删除分组信息
     *
     * @param pid 分组信息主键
     */
    @Transactional(rollbackFor = Exception.class)
    public void delete(String pid) {
        repository.deleteById(pid);
    }


    /**
     * 通过主键获取分组信息实体类
     *
     * @param id 分组的主键
     * @return 分组信息实体类
     */
    @Transactional(readOnly = true)
    public Optional<GroupDetails> findById(String id) {
        return repository.findById(id);
    }


    /**
     * 查询当前操作人创建的分组信息，并将分组信息按照时间降序排列
     *
     * @param operatorId 操作人主键，详情参考{@link GroupDetails#getPid()}
     * @return 返回当前操作的分组详情集合，详情参考{@link SimpleGroupInfo}对象
     */
    public List<SimpleGroupInfo> findAllGroupSimpleInfo(String operatorId) {
        return repository.findByUserPidOrderByCreateTimeDesc(operatorId, SimpleGroupInfo.class);
    }

    /**
     * 根据分组主键更新分组邀请码，详情参考{@link GroupDetails#getPid()}
     *
     * @param id 分组主键
     */
    @Transactional(rollbackFor = RuntimeException.class)
    public void generateInviteCode(String id) {
        GroupDetails groupDetails = repository.findById(id)
                .orElseThrow(() -> new BusinessException(HttpStatus.BAD_REQUEST, Translator.toLocale("group.NotExists.message")));
        groupDetails.setInviteCode(generateInviteCode());
        repository.save(groupDetails);
    }

    /**
     * 生成分组邀请码，最多尝试5次
     *
     * @return 返回邀请码字符除按
     */
    public String generateInviteCode() {

        String inviteCode;
        int tryNum = 1;
        do {
            Random random = new Random();
            inviteCode = CompetitionUtils.getInstance().getInvitationCode((long) Math.abs(random.nextInt()));
            tryNum++;
        } while (repository.findByInviteCodeWithLock(inviteCode).isPresent() && tryNum <= generate_code_max_try);
        if (tryNum > generate_code_max_try) {
            throw new BusinessException(Translator.toLocale("user.create.Conflict.message"));
        }
        return inviteCode;
    }

    @Transactional(rollbackFor = RuntimeException.class)
    public void generateInviteCodeBatch() {
        List<GroupDetails> groups = repository.findByInviteCodeIsNull();
        if (groups.isEmpty()) {
            return;
        }
        groups.forEach(group -> {
            Random random = new Random();
            group.setInviteCode(CompetitionUtils.getInstance().getInvitationCode((long) Math.abs(random.nextInt())));
        });
        repository.saveAll(groups);
    }
}



// 持久层
public interface GroupDetailsRepository extends JpaRepository<GroupDetails, String>, JpaSpecificationExecutor {

    long countByGroupNameAndOrgPid(String name, String orgPid);

    /**
     * 查询创建人创建每个分组的人数集合
     *
     * @param usrPid 创建人pid
     * @return
     */
    @Query("SELECT\n" +
            "model.pid,\n" +
            "COUNT(gdu.pid)\n" +
            "FROM\n" +
            "GroupDetails model\n" +
            "LEFT JOIN GroupDetailsUser gdu ON model.pid = gdu.groupDetailsPid \n" +
            "WHERE\n" +
            "model.userPid = :usrPid\n" +
            "GROUP BY\n" +
            "model.pid")
    Stream<Object[]> countGroupUserNumberByOperatorId(@Param("usrPid") String usrPid);

    Long countAllByUserPid(String userPid);

    <T> List<T> findByUserPidOrderByCreateTimeDesc(String userPid, Class<T> type);

    Optional<GroupDetails> findByInviteCode(String code);

    List<GroupDetails> findByInviteCodeIsNull();

    @Query(value = "SELECT model FROM GroupDetails model\n" +
            "INNER JOIN TaskGroup tg ON tg.groupDetailsPid = model.pid\n" +
            "INNER JOIN TaskContent tc ON tc.taskPid = tg.taskPid\n" +
            "WHERE tc.competitionPid = :pid")
    List<GroupDetails> findByCompetitionPid(@Param("pid") Long competitionPid);

    @Query("SELECT model FROM GroupDetails model WHERE model.inviteCode = :code")
    @Lock(LockModeType.PESSIMISTIC_WRITE)
    Optional<GroupDetails> findByInviteCodeWithLock(@Param("code") String code);
}
```



### 提交作品
```java
/**
     * 提交/重新提交任务作品
     *
     * @param pid               赛事作品主键，详情参考{@link CompetitionProject#getPid()}
     * @param projectPid        用户作品主键，详情参考{@link ProjectInfo#getPid()}
     * @param title             作品名称，详情参考{@link ProjectInfo#getProjectTitle()}
     * @param taskContentPid    任务关联分组主键，详情参考{@link cn.com.coding4fun.hibernate.entity.TaskContent#getPid()}
     * @param competitionPid    赛事主键，详情参考{@link CompetitionInfo#getPid()}
     * @param taskGroupPid      任务分组主键，详情参考{@link TaskGroup#getPid()}
     * @return
     */
    @RequestMapping(method = {RequestMethod.POST, RequestMethod.PUT}, value = "/task/project")
    public ResponseEntity save(@RequestDecryptPrimaryKey(required = false) Long pid,
                               @RequestParam(name = "piPid")  @NotEmpty(message = "{competition.project.NotSelect.message}") String projectPid,
                               @RequestParam(name = "title") @NotEmpty(message = "{project.name.NotExists.message}") String title,
                               @RequestDecryptPrimaryKey(name = "tcPid") @NotNull(message = "{task.NotExists.message}") Long taskContentPid,
                               @RequestDecryptPrimaryKey(name = "cPid") @NotNull(message = "{competition.NotExists.message}") Long competitionPid,
                               @RequestDecryptPrimaryKey(name = "tgPid") @NotNull(message = "{group.NotExists.message}") Long taskGroupPid) {
        if ("null".equals(title))
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(Translator.toLocale("project.name.NotExists.message"));
        CompetitionInfo competitionInfo = competitionInfoService.findById(competitionPid)
                .orElseThrow(() -> new BusinessException(HttpStatus.BAD_REQUEST, Translator.toLocale("competition.NotExists.message")));
        if (LocalDateTime.now().isAfter(competitionInfo.getReviewTime())) {
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(Translator.toLocale("competition.project.NotSubmit.message"));
        }
        if (!taskManageService.findByTaskGroupPid(taskGroupPid).isPresent()) {
            return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(Translator.toLocale("group.NotExists.message"));
        }
        // 根据Scratch3.0作品主键查询作品是否存在，不存在直接抛出异常
        final BusinessException projectException = new BusinessException(HttpStatus.BAD_REQUEST, Translator.toLocale("project.NotExists.message"));
        ProjectInfo projectInfo = projectService.findByPid(projectPid)
                .orElseThrow(() -> projectException);
        CompetitionProject project = new CompetitionProject();
        if (!Objects.isNull(pid)) {
            project = service.findById(pid)
                    .orElseThrow(() -> projectException);
        }
        project.setThumbnail(projectInfo.getImagePath());
        project.setProjectTitle(title);
        project.setProjectPid(projectInfo.getPid());
        project.setTaskContentPid(taskContentPid);
        project.setCompetitionPid(competitionPid);
        project.setTaskGroupPid(taskGroupPid);
        project.setHitsNumber(Long.valueOf(0));
        project.setGoodNumber(Long.valueOf(0));
        project.setUserPid(getOperatorId());
        project.setProjectType(ProjectTypeEnum.SCRATCH3.getTypeName());
        project.setStatus(1);
        service.save(project);
        return ResponseEntity.status(HttpStatus.CREATED).body(Translator.toLocale("system.operator.success.message"));
    }



    // 业务逻辑层
        /**
     * 通过任务分组主键查找任务分组
     * @param pid   任务分组主键
     * @return
     */
    public Optional<TaskGroup> findByTaskGroupPid(Long pid) {
        return taskGroupRepository.findByPid(pid);
    }


    // 持久层
    Optional<TaskGroup> findByPid(Long pid);
```


![](https://cdn.jsdelivr.net/gh/xzMhehe/StaticFile_CDN/static/img/20210701154010.png)
![](https://cdn.jsdelivr.net/gh/xzMhehe/StaticFile_CDN/static/img/20210701153956.png)





## 学习平台（老项目）
### 查询课程分类
```java
/**
     * 查询类别通过课程编号
     *
     * @return
     */
    @GetMapping("type")
    public RestResponseEntity<ArrayList<String>> findCourseTypeByID(@RequestParam String id,
                                                                    @RequestParam String cid) {
        try {
            if (WebStringUtils.isInvalid(id)) {
                logger.warn("课程ID无效");
                return new RestResponseEntity().failed(RestResponseStatus.INVALID_PARAMS, "课程ID无效");
            }
            CourseInfo course = courseInfoService.findById(id);
            if (course == null) {
                logger.warn("无法根据客户端提供的编号找到课程");
                return new RestResponseEntity().failed("无法根据客户端提供的编号找到课程");
            }
            /**
             * 查询课程类别以树结构展现
             */
            List<TreeNode> courseTreeNode = courseTypeService.findCourseType();
            TreeNode root = new TreeNode();
            root.setId("");
            root.setChildren(courseTreeNode);
            ArrayList<String> a = new ArrayList<>();
            ArrayList<String> pathList = TreeBuilder.findRootNodeToOtherNodePath(root, course.getCourseClassification(), a);
            if (pathList != null && !pathList.isEmpty()) {
                pathList.remove(0);
            }
            CourseStepSimple chapter = stepService.findById(cid);
            pathList.add(chapter.getScratchVersion().toString());
            return new RestResponseEntity().success(pathList);
        } catch (Exception e) {
            logger.error("程序异常", e);
            return new RestResponseEntity().failed();
        }
    }

    // 业务逻辑层 查询课程分类
    public List<TreeNode> findTreeByType(String dictType) {
        List<TreeNode> treeNodeList = repository.findByType(dictType);
        TreeBuilder<TreeNode> builder = new TreeBuilder(treeNodeList);
        List<TreeNode> tree = builder.buildListToTree();
        return tree;
    }

    // 持久层 查询课程分类
    public List<TreeNode> findByType(String type) {
        String queryString = "SELECT \n" +
                "new cn.com.coding4fun.iview.TreeNode(\n" +
                "model.pid, \n" +
                "model.parentPid,\n" +
                "model.label,\n" +
                "model.value,\n" +
                "model.descr,\n" +
                "model.remark,\n" +
                "model.sort,\n" +
                "model.iconPath \n" +
                ") \n" +
                "FROM SysDict model WHERE model.type = :type";
        return getCurrentSession()
                .createQuery(queryString, TreeNode.class)
                .setParameter("type", type)
                .getResultList();
    }
```



### 使用作品Id更新作品适配键盘


```java
/**
     * 使用作品Id更新作品适配键盘
     *
     * @param id
     * @param keyboard
     * @return
     */
    @PostMapping("keyboard/setting")
    public RestResponseEntity<String> updateAdaptiveKeyboardOfProject(@RequestParam String id,
                                                                      @RequestParam String keyboard) {
        if (WebStringUtils.isInvalid(id)) {
            return new RestResponseEntity<String>().failed("请选择作品");
        }
        if (WebStringUtils.isInvalid(keyboard) || (WebStringUtils.isValid(keyboard) && !AdaptiveKeyboardEnum.containOf(keyboard))) {
            return new RestResponseEntity<String>().failed("请选择要适配的键盘");
        }
        try {
            ProjectInfo projectInfo = service.findById(id);
            if (!Optional.ofNullable(projectInfo).isPresent()) {
                return new RestResponseEntity<String>().failed("请重新选择作品");
            }
            projectInfo.setAdaptiveKeyboard(keyboard);
            service.saveOrUpdate(projectInfo);
            return new RestResponseEntity<String>().success();
        } catch (Exception e) {
            logger.error("setting project keyboard failed", e);
            return new RestResponseEntity<String>().failed(e.getMessage());
        }
    }
```



### 教师获取学生答题情况
更改题目为答题结束状态
```java
@RestController
@RequestMapping("course/question")
public class CourseStepQuestionRestController {

    private final Logger logger = LoggerFactory.getLogger(this.getClass());

    @Resource
    private CourseStepQuestionService service;

    @Resource
    private TeacherDistQuestionService distQuestionService;

    /**
     * 老师获取所有练习题
     *
     * @param cid 课程章节Id
     * @param tid 排课表Id
     * @return
     */
    @GetMapping
    public RestResponseEntity findQuestionByIds(@RequestParam String cid,
                                                @RequestParam String tid) {
        if (WebStringUtils.isInvalid(cid) || WebStringUtils.isInvalid(tid)) {
            return new RestResponseEntity().failed(RestResponseStatus.INVALID_PARAMS, "课程章节或排课编号无效");
        }
        try {
            return new RestResponseEntity().success(service.findByStepIdAndClassCourseTimeId(cid, tid));
        } catch (Exception e) {
            logger.error(e.getMessage(), e);
            return new RestResponseEntity().failed(e.getMessage());
        }
    }

    /**
     * 老师发布练习题
     *
     * @param cqstId 课程章节关联题目主键
     * @param tid    排课表主键
     * @return 返回发布题目的主键
     */
    @PostMapping("release")
    public RestResponseEntity<String> distQuestion(@RequestParam String cqstId,
                                                   @RequestParam String tid) {
        if (WebStringUtils.isInvalid(cqstId) || WebStringUtils.isInvalid(tid)) {
            return new RestResponseEntity().failed(RestResponseStatus.INVALID_PARAMS, "课程练习题或排课编号无效");
        }
        /**
         * 判断当节课有没有发布过这道题,发布过则提示已发布，没发布过创建发布记录
         */
        if (service.findByStepQuestionIdAndClassCourseTimeId(cqstId, tid) > 0L) {
            return new RestResponseEntity().failed(RestResponseStatus.FOUND_RECORD, "题目已经发布过，请不要重复发布");
        }
        try {
            return new RestResponseEntity<String>().success(service.distQuestion(cqstId, tid));
        } catch (Exception e) {
            logger.error(e.getMessage(), e);
            return new RestResponseEntity<String>().failed(e.getMessage());
        }
    }

    /**
     * 学生获取已发布的题目信息
     *
     * @param id 排课表主键
     * @return
     */
    @GetMapping({"/release"})
    public RestResponseEntity findReleasedQuestions(@RequestParam String id) {
        if (WebStringUtils.isInvalid(id)) {
            return new RestResponseEntity().failed(RestResponseStatus.INVALID_PARAMS, "排课编号无效");
        }
        try {
            return new RestResponseEntity<>().success(service.findReleasedQuestions(id));
        } catch (Exception e) {
            logger.error(e.getMessage(), e);
            return new RestResponseEntity().failed(e.getMessage());
        }
    }

    /**
     * 教师获取题目详情及学员答题状况
     *
     * @param qstId 课程章节关联的练习题主键
     * @param tid   班级课程时间表主键
     * @param type  0 查询正式题, 1 查询口述题
     * @return
     */
    @GetMapping("answer/result")
    public RestResponseEntity acquisitionAnswer(@RequestParam String qstId,
                                                @RequestParam String tid,
                                                @RequestParam Integer type) {
        try {
            QuestionTypeEnum questionType = QuestionTypeEnum.getItem(type);
            if (questionType == null) {
                return new RestResponseEntity().failed("不存在该类型的题目");
            }
            return new RestResponseEntity<>().success(distQuestionService.getQuestionDetail(qstId, tid, questionType));
        } catch (BusinessException e) {
            logger.error(e.getMessage(), e);
            return new RestResponseEntity().failed(e.getMessage());
        } catch (Exception e) {
            logger.error(e.getMessage(), e);
            return new RestResponseEntity().failed();
        }

    }

    /**
     * 教师改变题目发布为发题状态  1
     *
     * @param tdqId 题目发布主键
     * @return
     */
    @ResponseBody
    @PostMapping("release/status")
    public RestResponseEntity releaseAnswer(@Valid @RequestParam @NotNull @Size(min = 1, max = 32) String tdqId) {
        try {
            if (WebStringUtils.isInvalid(tdqId)) {
                return new RestResponseEntity().failed(RestResponseStatus.INVALID_PARAMS, "题目主键为空");
            }
            TeacherDistQuestion teacherDistQuestion = distQuestionService.findById(tdqId);
            if (teacherDistQuestion == null) {
                return new RestResponseEntity().failed(RestResponseStatus.NOT_FOUND_RECORD, "题目不存在");
            }
            teacherDistQuestion.setUpdateTime(LocalDateTime.now());
            teacherDistQuestion.setReleaseStatus(1);
            distQuestionService.saveOrUpdate(teacherDistQuestion);
            return new RestResponseEntity().success();
        } catch (Exception e) {
            logger.error(e.getMessage(), e);
            return new RestResponseEntity().failed(e.getMessage());
        }
    }
}


// 业务逻辑层
@Service
@Transactional
public class CourseStepQuestionService implements IBaseService<CourseStepQuestion, String> {

    private final String ORAL_QUESTION_NAME = "口述题";

    @Resource
    private CourseStepQuestionRepository repository;

    @Resource
    private TeacherDistQuestionRepository distQuestionRepository;

    @Resource
    private TeacherOralQuestionRepository teacherOralQuestionRepository;

    @Override
    public void delete(String pid) {
        repository.delete(new CourseStepQuestion(pid));
    }

    @Override
    public void delete(CourseStepQuestion entity) {
        repository.delete(entity);
    }

    @Override
    public CourseStepQuestion findById(String pid) {
        return repository.findById(pid);
    }

    @Override
    public List<CourseStepQuestion> findAll() {
        return repository.findAll();
    }

    @Override
    public Page findAllByPage(Page page) throws IntrospectionException {
        return repository.findAllByPage(page);
    }

    @Override
    public void saveOrUpdate(CourseStepQuestion courseStepQuestion) {
        repository.saveOrUpdate(courseStepQuestion);
    }

    /**
     * 老师获取所有练习题
     *
     * @param stepId            课程章节Id
     * @param classCourseTimeId 排课表Id
     * @return
     */
    public List<? extends BaseQuestionDTO> findByStepIdAndClassCourseTimeId(String stepId, String classCourseTimeId) {
        List<BaseQuestionDTO> ctqList = repository.findByStepIdAndClassCourseTimeId(stepId, classCourseTimeId);
        List<TeacherOralQuestion> oralQuestions = teacherOralQuestionRepository.findByClassCourseTimeId(classCourseTimeId);
        int[] size = {1};
        List<OralQuestionDTO> oqtList = oralQuestions.stream()
                .map(question -> new OralQuestionDTO(question.getPid(), ORAL_QUESTION_NAME + size[0]++, "5"))
                .collect(Collectors.toList());
        return Stream.concat(ctqList.stream(), oqtList.stream())
                .collect(Collectors.toList());
    }

    /**
     * 查询此节课有没有发布本道题的记录
     *
     * @param cqstId 课程章节关联题目主键
     * @param tid    排课表主键
     * @return
     */
    public Long findByStepQuestionIdAndClassCourseTimeId(String cqstId, String tid) {
        return distQuestionRepository.findByStepQuestionIdAndClassCourseTimeId(cqstId, tid);
    }

    /**
     * 老师发布题目
     *
     * @param cqstId 课程章节关联题目主键
     * @param tid    排课表Id
     * @return 返回发布题目的主键
     */
    public String distQuestion(String cqstId, String tid) {
        TeacherDistQuestion entity = new TeacherDistQuestion();
        entity.setClassCourseTimePid(tid);
        entity.setCourseStepQuestionPid(cqstId);
        entity.setAnswerRightTotal(0);
        entity.setAnswerTotal(0);
        entity.setReleaseStatus(0);
        entity.setCreateTime(LocalDateTime.now());
        entity.setUpdateTime(LocalDateTime.now());
        distQuestionRepository.saveOrUpdate(entity);
        return entity.getPid();
    }

    /**
     * 学生获取已发布的题目信息
     *
     * @param classCourseTimeId 排课表主键
     * @return
     */
    public List<CourseStepQuestionDTO> findReleasedQuestions(String classCourseTimeId) {
        return repository.findAllReleasedByTPid(classCourseTimeId);
    }


}
```




![](https://cdn.jsdelivr.net/gh/xzMhehe/StaticFile_CDN/static/img/20210701155706.jpg)

